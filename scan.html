<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <!-- Google Tag Manager -->
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-N2CMV5HF');
    </script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <title>å¸ƒå¯æ˜Ÿçƒæ¢ç¢¼æƒæå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://unpkg.com/@zxing/browser@latest"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <link rel="stylesheet" href="src/css/scan.css?7">
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N2CMV5HF" height="0" width="0"
            style="display:none;visibility:hidden">
        </iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <div class="header-row">
            <h1>ğŸ“˜<span>å¸ƒå¯æ˜ŸçƒæŸ¥è©¢</span></h1>
        </div>
        <p class="subtitle">æƒææ›¸æœ¬æ¢ç¢¼ï¼Œåˆ¤åˆ¥æ˜¯å¦ç‚ºå¸ƒå¯æ˜Ÿçƒé¸æ›¸ã€‚</p>

        <div class="button-row">
            <button class="btn btn-main" id="startBtn">ğŸš€ é–‹å§‹æƒææ¢ç¢¼</button>
        </div>

        <div class="scanner-controls" style="display: none;">
            <button class="flash-btn flash-off" id="flashOffNew">ğŸ’¡é–‹ç‡ˆ</button>
            <button class="flash-btn flash-on" id="flashOnNew" style="display: none;">ğŸ’¡é—œç‡ˆ</button>
            <button class="btn btn-main danger" id="stopBtn">â¹ï¸ åœæ­¢æƒæ</button>
        </div>

        <div class="video-shell" id="videoShell">
            <video id="preview" autoplay playsinline muted></video>
            <div class="roi-overlay" id="roiOverlay"></div>
            <span class="hud-badge" id="engineBadge">å¾…å‘½ä¸­â€¦</span>
        </div>

        <div class="result-card" id="resultCard">
            âœ… è¼‰å…¥å¾Œè«‹é»ã€Œé–‹å§‹æƒæã€ï¼Œå°‡æ›¸æœ¬æ¢ç¢¼ç½®ä¸­ä¸¦ç¶­æŒ 15-20 å…¬åˆ†è·é›¢ã€‚
        </div>

        <div class="status-board" id="statusBoard">
            <div>ğŸ“· ç›¸æ©Ÿç‹€æ…‹ï¼š<span id="cameraStatus">å°šæœªå•Ÿå‹•</span></div>
            <div>ğŸ§  å¼•æ“ç‹€æ…‹ï¼š<span id="engineStatus">å°šæœªæƒæ</span></div>
        </div>

        <div class="success-popover" id="successPopover" style="display: none;">
            âœ… æƒææˆåŠŸï¼
        </div>

    </div>

    <canvas id="processingCanvas" class="hidden"></canvas>
    <canvas id="scratchCanvas" class="hidden"></canvas>

    <script>
        (() => {
            // === DOM å…ƒç´ å¿«å– ===
            const elements = {
                startBtn: document.getElementById('startBtn'),
                stopBtn: document.getElementById('stopBtn'),
                scannerControls: document.querySelector('.scanner-controls'),
                flashOffBtn: document.getElementById('flashOffNew'),
                flashOnBtn: document.getElementById('flashOnNew'),
                preview: document.getElementById('preview'),
                roiOverlay: document.getElementById('roiOverlay'),
                engineBadge: document.getElementById('engineBadge'),
                cameraStatus: document.getElementById('cameraStatus'),
                engineStatus: document.getElementById('engineStatus'),
                resultCard: document.getElementById('resultCard'),
                statusBoard: document.getElementById('statusBoard'),
                successPopover: document.getElementById('successPopover'),
                appVersion: document.querySelector('.app-version')
            };

            // === Canvas å…ƒç´ å’Œä¸Šä¸‹æ–‡ ===
            const processingCanvas = document.getElementById('processingCanvas');
            const processingCtx = processingCanvas.getContext('2d', { willReadFrequently: true });
            const scratchCanvas = document.getElementById('scratchCanvas');
            const scratchCtx = scratchCanvas.getContext('2d', { willReadFrequently: true });

            // === æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ===
            const state = {
                // æƒæç‹€æ…‹
                running: false,
                detectionBusy: false,
                lastDetectionAt: 0,

                // è³‡æ–™ç‹€æ…‹
                bookList: [],
                stream: null,
                track: null,
                flashOn: false,

                // æª¢æ¸¬å¼•æ“
                detectors: {
                    barcodeDetector: null,
                    multiFormatReader: null
                },

                // çµ±è¨ˆè³‡æ–™
                stats: {
                    frames: 0,
                    valid: 0,
                    success: 0
                },

                // ROI è¨­å®š
                roi: {
                    enabled: true,
                    widthRatio: 0.78,
                    heightRatio: 0.42
                },

                // å½±åƒè™•ç†è¨­å®š
                processing: {
                    contrast: 1.35,
                    brightness: 1.05,
                    gamma: 0.9,
                    denoise: true,
                    sharpen: true
                },

                // æª¢æ¸¬è¨­å®š
                detection: {
                    allowRotation: true,
                    allowSlices: true,
                    useBarcodeDetector: true,
                    useZxing: true,
                    intervalMs: 120,
                    rotationAngles: [-12, -6, 6, 12],
                    slices: [
                        { label: 'ä¸­å¿ƒ', topRatio: 0.25, heightRatio: 0.5 },
                        { label: 'ä¸Šæ–¹', topRatio: 0.05, heightRatio: 0.45 },
                        { label: 'ä¸‹æ–¹', topRatio: 0.5, heightRatio: 0.45 }
                    ]
                },

                // å¿«å–å’Œæ—¥èªŒ
                lastCodes: [],
                logSize: 120,

                // ç›¸æ©Ÿè¨­å®šï¼ˆå°‡è¢«å¤–éƒ¨è¨­å®šè¦†è“‹ï¼‰
                cameraConfig: {
                    facingMode: 'environment',
                    idealWidth: 1920,
                    idealHeight: 1080,
                    minWidth: 640,
                    minHeight: 480
                },

                // UI è¨­å®šï¼ˆå°‡è¢«å¤–éƒ¨è¨­å®šè¦†è“‹ï¼‰
                uiConfig: {
                    loadingDelay: 700,
                    popoverDuration: 1500,
                    fadeOutDelay: 300
                },

                // æ•ˆèƒ½è¨­å®š
                maxCanvasWidth: 1280,
                recentCodeHistorySize: 12,

                // UI/æ“ä½œé˜²å‘†æ——æ¨™
                isStarting: false,
                isStopping: false,
                flashBusy: false
            };

            // === å¸¸æ•¸å®šç¾© ===
            const SUPPORTED_FORMATS = [
                'ean_13', 'ean_8', 'upc_a', 'upc_e',
                'code_128', 'code_39', 'code_93', 'itf', 'codabar'
            ];

            // ZXing ç›¸é—œè®Šæ•¸
            let ZXING_AVAILABLE = false;
            let ZXING_FORMATS = [];

            // === è¼”åŠ©å‡½æ•¸ ===

            /**
             * æª¢æŸ¥ ZXing æ˜¯å¦å¯ç”¨ï¼ˆå»¶é²æª¢æŸ¥ï¼‰
             * @returns {boolean} ZXing æ˜¯å¦å¯ç”¨
             */
            function checkZXingAvailability() {
                try {
                    ZXING_AVAILABLE = typeof window.ZXing !== 'undefined' &&
                        typeof window.ZXingBrowser !== 'undefined';

                    if (ZXING_AVAILABLE) {
                        ZXING_FORMATS = [
                            ZXing.BarcodeFormat.EAN_13,
                            ZXing.BarcodeFormat.EAN_8,
                            ZXing.BarcodeFormat.UPC_A,
                            ZXing.BarcodeFormat.UPC_E,
                            ZXing.BarcodeFormat.CODE_128,
                            ZXing.BarcodeFormat.CODE_39,
                            ZXing.BarcodeFormat.ITF
                        ];
                    }
                    return ZXING_AVAILABLE;
                } catch (error) {
                    log(`ZXing æª¢æŸ¥å¤±æ•—ï¼š${error.message}`);
                    ZXING_AVAILABLE = false;
                    return false;
                }
            }

            /**
             * é™åˆ¶æ•¸å€¼åœ¨æŒ‡å®šç¯„åœå…§
             * @param {number} value - è¦é™åˆ¶çš„å€¼
             * @param {number} min - æœ€å°å€¼
             * @param {number} max - æœ€å¤§å€¼
             * @returns {number} é™åˆ¶å¾Œçš„å€¼
             */
            function clamp(value, min = 0, max = 255) {
                return Math.min(max, Math.max(min, value));
            }

            /**
             * è¼¸å‡ºå¸¶æ™‚é–“æˆ³çš„æ—¥èªŒè¨Šæ¯
             * @param {string} message - æ—¥èªŒè¨Šæ¯
             */
            function log(message) {
                const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                console.log(`[${timestamp}] ${message}`);
            }

            /**
             * è¼‰å…¥æƒæè¨­å®šæª”æ¡ˆ
             * @returns {Promise<void>}
             */
            async function loadScanConfig() {
                try {
                    log('æ­£åœ¨åˆå§‹åŒ–æƒæè¨­å®š...');
                    const response = await fetch('config/scan_config.json');
                    const config = await response.json();

                    // ä½¿ç”¨å¤–éƒ¨è¨­å®šè¦†è“‹é è¨­å€¼
                    if (config.roi) {
                        Object.assign(state.roi, config.roi);
                    }
                    if (config.processing) {
                        Object.assign(state.processing, config.processing);
                    }
                    if (config.detection) {
                        Object.assign(state.detection, config.detection);
                    }
                    if (config.performance) {
                        if (config.performance.logSize) state.logSize = config.performance.logSize;
                        if (config.performance.maxCanvasWidth) state.maxCanvasWidth = config.performance.maxCanvasWidth;
                        if (config.performance.recentCodeHistorySize) state.recentCodeHistorySize = config.performance.recentCodeHistorySize;
                    }
                    if (config.camera) {
                        state.cameraConfig = config.camera;
                    }
                    if (config.ui) {
                        state.uiConfig = config.ui;
                    }

                    log('âœ… æƒæè¨­å®šè¼‰å…¥æˆåŠŸ');
                    log(`ROI: ${state.roi.widthRatio}Ã—${state.roi.heightRatio}, è™•ç†: å°æ¯”åº¦${state.processing.contrast}, æª¢æ¸¬é–“éš”: ${state.detection.intervalMs}ms`);
                } catch (error) {
                    log(`âš ï¸ æƒæè¨­å®šè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼: ${error.message}`);
                    // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä¿æŒä½¿ç”¨ç¨‹å¼ç¢¼ä¸­çš„é è¨­å€¼
                }
            }

            /**
             * éåŒæ­¥è¼‰å…¥æ›¸ç±æ¸…å–®è³‡æ–™
             * @returns {Promise<void>}
             */
            async function loadBookList() {
                try {
                    // Plan B: æ”¯æ´ç²¾ç°¡ç‰ˆè³‡æ–™é›†ï¼ˆbooks_list.sample.jsonï¼‰
                    const params = new URLSearchParams(location.search);
                    const modeParam = params.get('mode');
                    const storedMode = localStorage.getItem('bookPlanetDatasetMode');
                    const datasetMode = (modeParam === 'lite' || modeParam === 'full') ? modeParam : (storedMode || 'full');
                    const dataUrl = datasetMode === 'lite' ? 'data/books_list.sample.json' : 'data/books_list.json';

                    const response = await fetch(dataUrl);
                    state.bookList = await response.json();

                    // æ›´æ–° UI é¡¯ç¤ºè¼‰å…¥çµæœ
                    elements.resultCard.classList.remove('error', 'success');
                    const modeBadge = datasetMode === 'lite' ? 'ï¼ˆç²¾ç°¡ç‰ˆï¼‰' : '';
                    elements.resultCard.textContent = `ğŸ“š å·²è¼‰å…¥ ${state.bookList.length} æœ¬å¸ƒå¯æ˜Ÿçƒé¸æ›¸${modeBadge}ï¼Œæº–å‚™é–‹å§‹æƒæã€‚`;

                    // å°‡ state æš´éœ²çµ¦å…¨åŸŸï¼Œä¾›çµ±è¨ˆåŠŸèƒ½ä½¿ç”¨
                    window.state = state;

                    // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œé€šçŸ¥æ›¸ç±è¼‰å…¥å®Œæˆ
                    window.dispatchEvent(new CustomEvent('booksLoaded', {
                        detail: { count: state.bookList.length }
                    }));
                } catch (error) {
                    elements.resultCard.classList.add('error');
                    elements.resultCard.textContent = 'âŒ æ›¸å–®è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™æª”æ˜¯å¦å­˜åœ¨ã€‚';
                    log(`æ›¸å–®è¼‰å…¥å¤±æ•—ï¼š${error.message}`);

                    // è¼‰å…¥å¤±æ•—æ™‚ä¹Ÿè§¸ç™¼äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('booksLoadError'));
                }
            }

            function initDetectors() {
                // åˆå§‹åŒ– BarcodeDetector
                if ('BarcodeDetector' in window) {
                    try {
                        state.detectors.barcodeDetector = new BarcodeDetector({ formats: SUPPORTED_FORMATS });
                        log('âœ… BarcodeDetector å·²å•Ÿç”¨');
                    } catch (error) {
                        log(`âš ï¸ BarcodeDetector åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`);
                        state.detectors.barcodeDetector = null;
                        state.detection.useBarcodeDetector = false;
                    }
                } else {
                    log('â„¹ï¸ æ­¤è£ç½®å°šæœªæ”¯æ´ BarcodeDetector åŸç”Ÿ APIã€‚');
                    state.detectors.barcodeDetector = null;
                    state.detection.useBarcodeDetector = false;
                }

                // å»¶é²åˆå§‹åŒ– ZXing
                setTimeout(() => {
                    if (!checkZXingAvailability()) {
                        log('â„¹ï¸ ZXing Browser å¥—ä»¶æœªå®Œå…¨è¼‰å…¥ï¼Œå°‡ä¸»è¦ä¾è³´åŸç”Ÿå¼•æ“ã€‚');
                        state.detectors.multiFormatReader = null;
                        state.detection.useZxing = false;
                        return;
                    }

                    try {
                        const hints = new Map();
                        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, ZXING_FORMATS);
                        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                        const reader = new ZXing.MultiFormatReader();
                        reader.setHints(hints);
                        state.detectors.multiFormatReader = reader;
                        log('âœ… ZXing MultiFormatReader å·²å•Ÿç”¨');
                    } catch (error) {
                        log(`âš ï¸ ZXing åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`);
                        state.detectors.multiFormatReader = null;
                        state.detection.useZxing = false;
                    }
                }, 1000); // å»¶é²1ç§’åˆå§‹åŒ–ZXing
            }

            function updateRoiOverlay() {
                if (!state.roi.enabled) {
                    elements.roiOverlay.style.display = 'none';
                    return;
                }
                const video = elements.preview;
                if (!video.videoWidth || !video.videoHeight) {
                    elements.roiOverlay.style.display = 'none';
                    return;
                }
                const container = document.getElementById('videoShell');
                const rect = container.getBoundingClientRect();
                const roiWidth = rect.width * state.roi.widthRatio;
                const roiHeight = rect.height * state.roi.heightRatio;
                elements.roiOverlay.style.display = 'block';
                elements.roiOverlay.style.width = `${roiWidth}px`;
                elements.roiOverlay.style.height = `${roiHeight}px`;
                elements.roiOverlay.style.left = `${(rect.width - roiWidth) / 2}px`;
                elements.roiOverlay.style.top = `${(rect.height - roiHeight) / 2}px`;
            }

            function resetStats() {
                state.stats.frames = 0;
                state.stats.valid = 0;
                state.stats.success = 0;
                state.lastCodes = [];
                updateStatsDisplay();
            }

            function updateStatsDisplay() {
                // Stats tracking kept for internal logic but not displayed
            }

            function pushRecentCode(code) {
                state.lastCodes.push(code);
                if (state.lastCodes.length > state.recentCodeHistorySize) state.lastCodes.shift();
            }

            function wasRecentlySeen(code) {
                return state.lastCodes.includes(code);
            }

            function applyImageProcessing(imageData, width, height) {
                const data = imageData.data;
                const contrast = state.processing.contrast;
                const brightness = state.processing.brightness;
                const gamma = state.processing.gamma;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    gray = gray * brightness;
                    gray = (gray - 128) * contrast + 128;
                    gray = 255 * Math.pow(clamp(gray) / 255, gamma);
                    const value = clamp(gray);
                    data[i] = data[i + 1] = data[i + 2] = value;
                }

                if (state.processing.denoise) {
                    applyBoxBlur(imageData, width, height);
                }

                if (state.processing.sharpen) {
                    applyUnsharpMask(imageData, width, height);
                }
            }

            function applyBoxBlur(imageData, width, height) {
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                const kernel = [
                    1, 1, 1,
                    1, 1, 1,
                    1, 1, 1
                ];
                const kernelWeight = 9;
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let sum = 0;
                        let idxKernel = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4;
                                sum += original[idx] * kernel[idxKernel++];
                            }
                        }
                        const value = clamp(sum / kernelWeight);
                        const target = (y * width + x) * 4;
                        data[target] = data[target + 1] = data[target + 2] = value;
                    }
                }
            }

            // === å½±åƒè™•ç†åŠŸèƒ½ ===

            /**
             * æ‡‰ç”¨ééŠ³åŒ–é®ç½©æ¿¾é¡å¢å¼·å½±åƒæ¸…æ™°åº¦
             * @param {ImageData} imageData - è¦è™•ç†çš„å½±åƒè³‡æ–™
             * @param {number} width - å½±åƒå¯¬åº¦
             * @param {number} height - å½±åƒé«˜åº¦
             */
            function applyUnsharpMask(imageData, width, height) {
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                const amount = 0.6; // éŠ³åŒ–å¼·åº¦

                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const center = original[idx];
                        const north = original[idx - width * 4];
                        const south = original[idx + width * 4];
                        const east = original[idx + 4];
                        const west = original[idx - 4];

                        // æ‹‰æ™®æ‹‰æ–¯é‚Šç·£æª¢æ¸¬
                        const laplace = (4 * center) - north - south - east - west;
                        const value = clamp(center + amount * laplace);

                        // æ‡‰ç”¨åˆ° RGB ä¸‰å€‹é€šé“
                        data[idx] = data[idx + 1] = data[idx + 2] = value;
                    }
                }
            }

            /**
             * è¨ˆç®—æ„Ÿèˆˆè¶£å€åŸŸï¼ˆROIï¼‰çš„åº§æ¨™å’Œå¤§å°
             * @param {number} videoWidth - å½±ç‰‡å¯¬åº¦
             * @param {number} videoHeight - å½±ç‰‡é«˜åº¦
             * @returns {Object} ROI å€åŸŸè³‡è¨Š {sx, sy, sw, sh}
             */
            function computeRoi(videoWidth, videoHeight) {
                if (!state.roi.enabled) {
                    return { sx: 0, sy: 0, sw: videoWidth, sh: videoHeight };
                }

                const sw = videoWidth * state.roi.widthRatio;
                const sh = videoHeight * state.roi.heightRatio;
                const sx = (videoWidth - sw) / 2;
                const sy = (videoHeight - sh) / 2;

                return { sx, sy, sw, sh };
            }

            // === UI æ›´æ–°åŠŸèƒ½ ===

            /**
             * æ ¹æ“šåŒ¹é…çµæœæ›´æ–°çµæœå¡ç‰‡é¡¯ç¤º
             * @param {Object} match - åŒ¹é…çµæœç‰©ä»¶ {found, original, matchedCode}
             */
            function showLoadingCard() {
                elements.resultCard.classList.remove('error', 'success');
                // æ¸…é™¤æˆåŠŸèƒŒæ™¯åœ–ï¼ˆé¿å…æ®˜ç•™ï¼‰
                elements.resultCard.classList.remove('has-bg');
                elements.resultCard.style.removeProperty('--result-bg');
                elements.resultCard.innerHTML = `
                    <div class="loading-card">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                        <div class="loading-text">
                            æ­£åœ¨æŸ¥è©¢æ›¸ç±è³‡è¨Š...
                        </div>
                    </div>
                `;
            }

            function updateResultCardForMatch(match) {
                if (match.found) {
                    // é¡¯ç¤ºæˆåŠŸåŒ¹é…çµæœ
                    elements.resultCard.classList.remove('error');
                    elements.resultCard.classList.add('success');
                    // å¥—ç”¨èƒŒæ™¯åœ–ï¼ˆ20% é€æ˜ï¼Œåœ¨ CSS æ§åˆ¶ï¼‰ï¼Œå˜—è©¦å¤šå€‹å¸¸è¦‹è·¯å¾‘ï¼Œå„ªå…ˆä½¿ç”¨ bg.jpg
                    setResultCardBg([
                        'src/img/bg.jpg',
                        'bg.jpg',
                        'src/bg.jpg',
                        'images/bg.jpg',
                        'assets/bg.jpg',
                        // å¾Œå‚™ï¼šå…ˆå‰çš„é è¨­åœ–
                        'src/img/success-bg.png'
                    ]);
                    elements.resultCard.innerHTML = `
                        <div class="success-title">
                            <span class="success-icon">ğŸ‰</span>
                            æ­å–œæ‰¾åˆ°ã€å¸ƒå¯æ˜Ÿçƒé¸æ›¸ã€
                        </div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                            ${match.found.æ›¸å}
                        </div>
                        <div style="margin-bottom: 4px;">
                            <strong>ISBNï¼š</strong>${match.found.ISBN}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>é©åˆå°è±¡ï¼š</strong>
                            ${renderAudienceChips(match.found.é©åˆå°è±¡)}
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); padding-top: 8px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                            åŒ¹é…æ¢ç¢¼ï¼š${match.matchedCode}
                        </div>
                    `;
                } else {
                    // é¡¯ç¤ºæœªæ‰¾åˆ°çš„çµæœ
                    elements.resultCard.classList.remove('success');
                    // æœªåŒ¹é…æ™‚ç§»é™¤ä»»ä½•èƒŒæ™¯åœ–
                    elements.resultCard.classList.remove('has-bg');
                    elements.resultCard.style.removeProperty('--result-bg');
                    elements.resultCard.classList.add('error');
                    elements.resultCard.innerHTML = `
                        <div class="error-title">
                            <span class="error-icon">âš ï¸</span>
                            æœªåœ¨å¸ƒå¯æ˜Ÿçƒæ›¸å–®ä¸­
                        </div>
                        <div style="font-size: 16px; margin: 12px 0; font-weight: 500;">
                            æ­¤æ¢ç¢¼ä¸åœ¨å¸ƒå¯æ˜Ÿçƒé¸æ›¸æ¸…å–®ä¸­
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 12px; margin-top: 16px;">
                            <div style="font-size: 13px; margin-bottom: 4px; color: var(--text-muted);">
                                <strong>æƒææ¢ç¢¼ï¼š</strong>${match.original}
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                <strong>è™•ç†çµæœï¼š</strong>${match.matchedCode || 'ç„¡æ³•è­˜åˆ¥'}
                            </div>
                        </div>
                    `;
                }
            }

            // å˜—è©¦è¼‰å…¥çµæœå¡èƒŒæ™¯åœ–ï¼Œæ‰¾åˆ°å¯ç”¨è·¯å¾‘æ‰å¥—ç”¨
            function setResultCardBg(candidates) {
                if (!Array.isArray(candidates) || candidates.length === 0) return;
                let idx = 0;
                const tryNext = () => {
                    if (idx >= candidates.length) {
                        // å…¨éƒ¨å¤±æ•—å°±ä¸é¡¯ç¤ºèƒŒæ™¯
                        elements.resultCard.classList.remove('has-bg');
                        elements.resultCard.style.removeProperty('--result-bg');
                        return;
                    }
                    const url = candidates[idx++];
                    const img = new Image();
                    img.onload = () => {
                        const abs = new URL(url, document.baseURI).href;
                        elements.resultCard.style.setProperty('--result-bg', `url('${abs}')`);
                        elements.resultCard.classList.add('has-bg');
                    };
                    img.onerror = tryNext;
                    img.src = url;
                };
                tryNext();
            }

            // é©åˆå°è±¡é¡è‰²æ¨™ç±¤æ¸²æŸ“
            function renderAudienceChips(audienceRaw) {
                if (!audienceRaw) return '<span class="audience-chip chip-slate">æœªæ¨™ç¤º</span>';
                // æ”¯æ´å¤šç¨®åˆ†éš”ç¬¦è™Ÿï¼š/ã€ã€ï¼Œã€ç©ºç™½
                const parts = String(audienceRaw)
                    .split(/[\/ã€ï¼Œ,\s]+/)
                    .map(s => s.trim())
                    .filter(Boolean);
                if (parts.length === 0) return '<span class="audience-chip chip-slate">æœªæ¨™ç¤º</span>';
                const chips = parts.map(p => {
                    const cls = mapAudienceToChip(p);
                    return `<span class="audience-chip ${cls}" title="${p}">${p}</span>`;
                });
                return `<span class="audience-list">${chips.join('')}</span>`;
            }

            function mapAudienceToChip(label) {
                const l = (label || '').toString().toLowerCase();
                // å¸¸è¦‹ä¸­æ–‡åˆ†é¡
                if (l.includes('å¹¼å…’') || l.includes('å­¸é½¡å‰') || l.includes('ä½å¹¼')) return 'chip-rose';
                if (l.includes('ä½å¹´') || l.includes('ä½å¹´ç´š')) return 'chip-amber';
                if (l.includes('ä¸­å¹´') || l.includes('ä¸­å¹´ç´š')) return 'chip-lime';
                if (l.includes('é«˜å¹´') || l.includes('é«˜å¹´ç´š')) return 'chip-teal';
                if (l.includes('ä¸­é«˜')) return 'chip-sky';
                if (l.includes('åœ‹ä¸­') || l.includes('é’å°‘å¹´') || l.includes('ä¸­å­¸ç”Ÿ')) return 'chip-indigo';
                if (l.includes('é«˜ä¸­')) return 'chip-violet';
                if (l.includes('æˆäºº') || l.includes('æ•™å¸«') || l.includes('å®¶é•·')) return 'chip-slate';

                // å¹´é½¡å€é–“ï¼ˆæ•¸å­—ï¼‰
                if (/\d{1,2}\s*[-~è‡³]\s*\d{1,2}/.test(l)) return 'chip-sky';
                if (/^\d{1,2}\+?$/.test(l)) return 'chip-sky';

                // é è¨­
                return 'chip-slate';
            }

            // éš±è—æ¸¬è©¦ï¼šé»æ“Šç‰ˆæœ¬è™Ÿï¼Œæ¨¡æ“¬ã€Œæ‰¾åˆ°é¸æ›¸ã€ç•«é¢
            function triggerTestSuccessUI() {
                // æ¸›å°‘å¹²æ“¾ï¼šæš«åœæƒæ
                try { stopScanner(false); } catch (e) { }
                // æ¨™è¨˜æ¸¬è©¦æ¨¡å¼ï¼Œé¿å…è¨ˆæ¬¡
                window.__TEST_SUCCESS = true;

                // è‹¥æœ‰æ›¸å–®ï¼Œå–ç¬¬ä¸€æœ¬ç•¶åšç¤ºä¾‹ï¼Œå¦å‰‡ä½¿ç”¨å‡è³‡æ–™
                const sample = (state.bookList && state.bookList.length > 0) ? state.bookList[0] : {
                    æ›¸å: 'æ¸¬è©¦ç”¨ å¸ƒå¯é¸æ›¸',
                    ISBN: '9781234567890',
                    é©åˆå°è±¡: 'ä¸­é«˜å¹´ç´š'
                };
                const match = {
                    found: sample,
                    matchedCode: (sample.ISBN || '9781234567890').toString(),
                    original: 'TEST'
                };

                // æ¨¡æ“¬çœŸå¯¦æµç¨‹ï¼šå…ˆ Loading å†é¡¯ç¤ºæˆåŠŸ
                showLoadingCard();
                updateEngineBadge('æ¸¬è©¦æ¨¡å¼', true);
                elements.engineStatus.textContent = 'æ¸¬è©¦æ¨¡å¼';

                setTimeout(() => {
                    updateResultCardForMatch(match);
                    showSuccessPopover();
                }, state.uiConfig.loadingDelay);
            }

            // === æ¢ç¢¼è™•ç†åŠŸèƒ½ ===

            /**
             * é€²éšæ¢ç¢¼è™•ç†å™¨ï¼Œç”¢ç”Ÿå¤šç¨®å¯èƒ½çš„ISBNæ ¼å¼
             * @param {string} rawCode - åŸå§‹æ¢ç¢¼å­—ä¸²
             * @returns {Array<string>} è™•ç†å¾Œçš„å¯èƒ½ISBNæ ¼å¼é™£åˆ—ï¼ˆæœ€å°‘8ä½æ•¸ï¼‰
             */
            function advancedBarcodeProcessor(rawCode) {
                const cleaned = rawCode.replace(/\D/g, ''); // ç§»é™¤éæ•¸å­—å­—ç¬¦
                const results = new Set();

                if (!cleaned) return [];

                // åŠ å…¥æ¸…ç†å¾Œçš„åŸå§‹ç¢¼
                results.add(cleaned);

                // æ¨™æº–é•·åº¦è™•ç†
                if (cleaned.length === 18) results.add(cleaned.slice(0, 13));
                if (cleaned.length === 15) results.add(cleaned.slice(0, 10));
                if (cleaned.length > 13) results.add(cleaned.slice(0, 13));
                if (cleaned.length > 10) results.add(cleaned.slice(0, 10));

                // å»é™¤æœ€å¾Œä¸€ä½ï¼ˆå¯èƒ½æ˜¯æ ¡é©—ç¢¼ï¼‰
                if (cleaned.length > 8) {
                    results.add(cleaned.slice(0, cleaned.length - 1));
                }

                // æ»‘å‹•è¦–çª—è™•ç†ï¼ˆå°‹æ‰¾å¯èƒ½çš„ISBNï¼‰
                if (cleaned.length >= 10) {
                    for (let i = 0; i <= cleaned.length - 10; i++) {
                        const slice13 = cleaned.slice(i, i + 13);
                        const slice10 = cleaned.slice(i, i + 10);

                        if (slice13.length === 13) results.add(slice13);
                        if (slice10.length === 10) results.add(slice10);
                    }
                }

                // éæ¿¾çµæœï¼Œä¿ç•™è‡³å°‘8ä½æ•¸çš„å€™é¸ç¢¼
                return Array.from(results).filter(code => code.length >= 8);
            }

            /**
             * æ™ºæ…§æ›¸ç±åŒ¹é…åŠŸèƒ½ï¼Œä½¿ç”¨å¤šç¨®ç­–ç•¥å°‹æ‰¾æ›¸ç±
             * @param {string} rawCode - åŸå§‹æ¢ç¢¼å­—ä¸²
             * @returns {Object} åŒ¹é…çµæœ {found, original, matchedCode}
             */
            function intelligentBookMatch(rawCode) {
                const candidates = advancedBarcodeProcessor(rawCode);

                for (const candidate of candidates) {
                    const match = state.bookList.find(book => {
                        if (!book.ISBN) return false;

                        const normalized = book.ISBN.replace(/\D/g, '');

                        // å®Œå…¨åŒ¹é…
                        if (normalized === candidate) return true;

                        // ç›¸åŒé•·åº¦ä½†æœ€å¾Œä¸€ä½ä¸åŒï¼ˆæ ¡é©—ç¢¼å·®ç•°ï¼‰
                        if (normalized.length === candidate.length &&
                            normalized.substring(0, normalized.length - 1) === candidate.substring(0, candidate.length - 1)) {
                            return true;
                        }

                        // éƒ¨åˆ†åŒ…å«åŒ¹é…ï¼ˆå…è¨±å°å¹…é•·åº¦å·®ç•°ï¼‰
                        if (normalized.includes(candidate) || candidate.includes(normalized)) {
                            return Math.abs(normalized.length - candidate.length) <= 2;
                        }

                        return false;
                    });

                    if (match) {
                        return {
                            found: match,
                            matchedCode: candidate,
                            original: rawCode
                        };
                    }
                }

                return {
                    found: null,
                    matchedCode: candidates[0] || '',
                    original: rawCode
                };
            }

            // === æ¢ç¢¼åµæ¸¬åŠŸèƒ½ ===

            /**
             * ä½¿ç”¨åŸç”Ÿ BarcodeDetector API é€²è¡Œæ¢ç¢¼åµæ¸¬
             * @param {HTMLCanvasElement} canvas - è¦åµæ¸¬çš„ canvas å…ƒç´ 
             * @returns {Promise<Object|null>} åµæ¸¬çµæœæˆ– null
             */
            async function detectWithBarcodeDetector(canvas) {
                const detector = state.detectors.barcodeDetector;
                if (!detector || !state.detection.useBarcodeDetector) return null;

                try {
                    const detections = await detector.detect(canvas);
                    if (!detections || detections.length === 0) return null;

                    // å„ªå…ˆé¸æ“‡æœ‰æ•ˆé•·åº¦çš„æ¢ç¢¼ï¼Œå¦å‰‡é¸æ“‡ç¬¬ä¸€å€‹
                    const best = detections.find(det =>
                        det.rawValue && det.rawValue.replace(/\D/g, '').length >= 8
                    ) || detections[0];
                    if (!best || !best.rawValue) return null;

                    return {
                        text: best.rawValue,
                        engine: 'BarcodeDetector',
                        format: best.format || 'Unknown'
                    };
                } catch (error) {
                    log(`BarcodeDetector å¤±æ•—ï¼š${error.message}`);
                    return null;
                }
            }

            /**
             * ä½¿ç”¨ ZXing å‡½å¼åº«é€²è¡Œæ¢ç¢¼åµæ¸¬
             * @param {HTMLCanvasElement} canvas - è¦åµæ¸¬çš„ canvas å…ƒç´ 
             * @returns {Object|null} åµæ¸¬çµæœæˆ– null
             */
            function detectWithZxing(canvas) {
                const reader = state.detectors.multiFormatReader;
                if (!reader || !state.detection.useZxing || !checkZXingAvailability()) {
                    return null;
                }

                try {
                    const luminanceSource = new ZXingBrowser.HTMLCanvasElementLuminanceSource(canvas);
                    const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                    const result = reader.decodeWithState(binaryBitmap);

                    // é‡ç½®è®€å–å™¨ç‹€æ…‹
                    if (reader.reset) {
                        reader.reset();
                    }

                    if (!result) return null;

                    return {
                        text: result.getText(),
                        engine: 'ZXing',
                        format: result.getBarcodeFormat ? result.getBarcodeFormat().toString() : 'Unknown'
                    };
                } catch (error) {
                    try {
                        if (reader.reset) {
                            reader.reset();
                        }
                    } catch (resetError) {
                        log(`ZXing reset å¤±æ•—ï¼š${resetError.message}`);
                    }

                    if (!(error instanceof ZXing.NotFoundException)) {
                        log(`ZXing å¤±æ•—ï¼š${error.message}`);
                    }
                    return null;
                }
            }

            async function detectFromCanvas(canvas, stageLabel) {
                let detection = await detectWithBarcodeDetector(canvas);
                if (detection) {
                    detection.stage = stageLabel;
                    return detection;
                }
                detection = detectWithZxing(canvas);
                if (detection) {
                    detection.stage = stageLabel;
                    return detection;
                }
                return null;
            }

            async function tryDetections() {
                const baseDetection = await detectFromCanvas(processingCanvas, 'åŸºç¤å½±åƒ');
                if (baseDetection) return baseDetection;

                if (state.detection.allowRotation) {
                    for (const angle of state.detection.rotationAngles) {
                        scratchCanvas.width = processingCanvas.width;
                        scratchCanvas.height = processingCanvas.height;
                        scratchCtx.save();
                        scratchCtx.clearRect(0, 0, scratchCanvas.width, scratchCanvas.height);
                        scratchCtx.translate(scratchCanvas.width / 2, scratchCanvas.height / 2);
                        scratchCtx.rotate(angle * Math.PI / 180);
                        scratchCtx.drawImage(processingCanvas, -processingCanvas.width / 2, -processingCanvas.height / 2);
                        scratchCtx.restore();
                        const rotatedDetection = await detectFromCanvas(scratchCanvas, `æ—‹è½‰ ${angle}Â°`);
                        if (rotatedDetection) return rotatedDetection;
                    }
                }

                if (state.detection.allowSlices) {
                    for (const slice of state.detection.slices) {
                        const sliceHeight = Math.round(processingCanvas.height * slice.heightRatio);
                        const sliceTop = Math.round(processingCanvas.height * slice.topRatio);
                        scratchCanvas.width = processingCanvas.width;
                        scratchCanvas.height = sliceHeight;
                        scratchCtx.clearRect(0, 0, scratchCanvas.width, scratchCanvas.height);
                        scratchCtx.drawImage(
                            processingCanvas,
                            0,
                            sliceTop,
                            processingCanvas.width,
                            sliceHeight,
                            0,
                            0,
                            scratchCanvas.width,
                            sliceHeight
                        );
                        const sliceDetection = await detectFromCanvas(scratchCanvas, `æƒæç·š-${slice.label}`);
                        if (sliceDetection) return sliceDetection;
                    }
                }

                return null;
            }

            function updateEngineBadge(text, success = false) {
                elements.engineBadge.textContent = text;
                elements.engineBadge.style.background = success ? 'rgba(0, 230, 118, 0.8)' : 'rgba(0, 0, 0, 0.6)';
                elements.engineBadge.style.borderColor = success ? 'rgba(0, 230, 118, 0.9)' : 'rgba(255, 255, 255, 0.2)';
                elements.engineBadge.style.color = success ? '#00281f' : '#e0f2f1';
            }

            // éš±è— popover çš„è¼”åŠ©å‡½æ•¸
            function hidePopover() {
                const popover = elements.successPopover;
                if (popover) {
                    popover.classList.remove('show', 'fade-out');
                    popover.style.display = 'none';
                }
            }

            function showSuccessPopover() {
                const resultCard = elements.resultCard;
                const popover = elements.successPopover;

                log('ğŸ‰ é–‹å§‹é¡¯ç¤ºæˆåŠŸ Popover');
                log(`ResultCard: ${resultCard ? 'âœ…æ‰¾åˆ°' : 'âŒæœªæ‰¾åˆ°'}`);
                log(`Popover: ${popover ? 'âœ…æ‰¾åˆ°' : 'âŒæœªæ‰¾åˆ°'}`);

                if (!resultCard || !popover) {
                    log('âš ï¸ Popover æˆ– ResultCard å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // é‡ç½®æ‰€æœ‰æ¨£å¼å’Œé¡åˆ¥
                popover.classList.remove('show', 'fade-out');
                popover.style.display = 'block'; // é¡¯ç¤ºå…ƒç´ 
                popover.style.position = 'fixed';
                popover.style.zIndex = '9999';

                const rect = resultCard.getBoundingClientRect();
                log(`ResultCard ä½ç½®: left=${rect.left}, top=${rect.top}, width=${rect.width}, height=${rect.height}`);

                // è¨ˆç®—popoverä½ç½®ï¼ˆç›¸å°æ–¼è¦–çª—ï¼Œåœ¨ resultCard ä¸Šç·£ï¼‰
                const popoverLeft = rect.left + (rect.width / 2);
                const popoverTop = rect.top - 60; // åœ¨ resultCard ä¸Šæ–¹ 60px

                popover.style.left = `${popoverLeft}px`;
                popover.style.top = `${popoverTop}px`;
                popover.style.transform = 'translateX(-50%)';

                log(`Popover ä½ç½®è¨­å®š: left=${popoverLeft}px, top=${popoverTop}px`);
                log('ğŸ‰ Popover æ¨£å¼å·²è¨­å®šï¼Œæº–å‚™é¡¯ç¤ºå‹•ç•«');

                // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª
                popover.offsetHeight;

                // é¡¯ç¤ºå‹•ç•«
                requestAnimationFrame(() => {
                    log('âš¡ åŸ·è¡Œé¡¯ç¤ºå‹•ç•«ï¼šæ·»åŠ  show é¡åˆ¥');
                    popover.classList.add('show');

                    // æª¢æŸ¥æ˜¯å¦æˆåŠŸæ·»åŠ 
                    setTimeout(() => {
                        const hasShow = popover.classList.contains('show');
                        const computedStyle = window.getComputedStyle(popover);
                        log(`å‹•ç•«æª¢æŸ¥: showé¡åˆ¥=${hasShow}, opacity=${computedStyle.opacity}, transform=${computedStyle.transform}`);
                    }, 100);
                });

                // å»¶é²å¾Œæ·¡å‡ºï¼ˆä½¿ç”¨è¨­å®šæª”æ¡ˆä¸­çš„æ™‚é–“ï¼‰
                setTimeout(() => {
                    log('â° é–‹å§‹æ·¡å‡ºå‹•ç•«');
                    popover.classList.add('fade-out');
                    setTimeout(() => {
                        log('ğŸ”š æ¸…é™¤ Popover é¡åˆ¥å’Œæ¨£å¼');
                        popover.classList.remove('show', 'fade-out');
                        popover.style.position = 'absolute'; // æ¢å¾©åŸå§‹å®šä½
                        popover.style.display = 'none'; // éš±è—å…ƒç´ 
                    }, state.uiConfig.fadeOutDelay);
                }, state.uiConfig.popoverDuration);
            }

            async function processFrame() {
                const video = elements.preview;
                if (!video.videoWidth || !video.videoHeight) return null;

                const now = performance.now();
                if (now - state.lastDetectionAt < state.detection.intervalMs) return null;
                state.lastDetectionAt = now;

                const roi = computeRoi(video.videoWidth, video.videoHeight);
                const targetWidth = Math.min(state.maxCanvasWidth, Math.round(roi.sw));
                const targetHeight = Math.round(targetWidth * (roi.sh / roi.sw));
                processingCanvas.width = targetWidth;
                processingCanvas.height = targetHeight;
                processingCtx.drawImage(video, roi.sx, roi.sy, roi.sw, roi.sh, 0, 0, targetWidth, targetHeight);

                const imageData = processingCtx.getImageData(0, 0, targetWidth, targetHeight);
                applyImageProcessing(imageData, targetWidth, targetHeight);
                processingCtx.putImageData(imageData, 0, 0);

                const detection = await tryDetections();
                state.stats.frames++;
                updateStatsDisplay();
                return detection;
            }

            async function scanLoop() {
                while (state.running) {
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    if (!state.running) break;
                    if (state.detectionBusy) continue;
                    state.detectionBusy = true;
                    try {
                        const detection = await processFrame();
                        if (detection) {
                            handleDetection(detection);
                        }
                    } catch (error) {
                        log(`æƒæè¿´åœˆéŒ¯èª¤ï¼š${error.message}`);
                    } finally {
                        state.detectionBusy = false;
                    }
                }
            }

            function handleDetection(detection) {
                const cleaned = detection.text.replace(/\s+/g, '');
                if (cleaned.replace(/\D/g, '').length < 8) {
                    log(`ç•¥éçŸ­ç¢¼ï¼š${cleaned}`);
                    return;
                }

                if (wasRecentlySeen(cleaned)) {
                    return;
                }
                pushRecentCode(cleaned);

                state.stats.valid++;
                updateStatsDisplay();

                log(`âœ… ${detection.engine}(${detection.stage}) â†’ ${cleaned}`);
                elements.engineStatus.textContent = `${detection.engine} @ ${detection.stage}`;
                updateEngineBadge(`${detection.engine} å‘½ä¸­`, true);

                const match = intelligentBookMatch(cleaned);
                if (match.found) {
                    state.stats.success++;
                }
                updateStatsDisplay();

                // å…ˆé¡¯ç¤º Loading ç•«é¢
                showLoadingCard();

                // å»¶é²é¡¯ç¤ºå¯¦éš›çµæœï¼ˆä½¿ç”¨è¨­å®šæª”æ¡ˆä¸­çš„å»¶é²æ™‚é–“ï¼‰
                setTimeout(() => {
                    updateResultCardForMatch(match);

                    if (!match.found) {
                        setTimeout(() => {
                            updateEngineBadge('æŒçºŒæƒæä¸­â€¦');
                        }, 2000);
                        return;
                    }

                    log('ğŸ¯ æ‰¾åˆ°åŒ¹é…æ›¸ç±ï¼Œæº–å‚™é¡¯ç¤º popover');

                    // é¡¯ç¤ºæˆåŠŸpopover
                    showSuccessPopover();
                    stopScanner(false);
                }, state.uiConfig.loadingDelay);
            }

            async function startScanner() {
                if (state.running || state.isStarting || state.isStopping) return;
                state.isStarting = true;
                // ç«‹å³é˜²é‡å…¥èˆ‡é¿å…é€£é»
                elements.startBtn.disabled = true;

                try {
                    resetStats();
                    updateEngineBadge('å•Ÿå‹•æ”å½±æ©Ÿâ€¦');
                    elements.engineStatus.textContent = 'å•Ÿå‹•ä¸­';
                    log('æ­£åœ¨åˆå§‹åŒ–æ”å½±æ©Ÿâ€¦');

                    // å˜—è©¦ä½¿ç”¨ç°¡åŒ–çš„æ”å½±æ©Ÿè¨­å®š
                    try {
                        state.stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: state.cameraConfig.facingMode,
                                width: { ideal: state.cameraConfig.idealWidth, min: state.cameraConfig.minWidth },
                                height: { ideal: state.cameraConfig.idealHeight, min: state.cameraConfig.minHeight }
                            },
                            audio: false
                        });
                    } catch (error) {
                        // å¦‚æœå¤±æ•—ï¼Œå˜—è©¦æ›´åŸºæœ¬çš„è¨­å®š
                        log('å˜—è©¦åŸºæœ¬æ”å½±æ©Ÿè¨­å®š...');
                        state.stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: state.cameraConfig.facingMode },
                            audio: false
                        });
                    }

                    state.track = state.stream.getVideoTracks()[0];
                    elements.preview.srcObject = state.stream;
                    await elements.preview.play();

                    updateCameraStatusText();
                    updateRoiOverlay();

                    elements.startBtn.style.display = 'none';
                    elements.scannerControls.style.display = 'flex';
                    elements.stopBtn.disabled = false;
                    elements.stopBtn.style.display = 'inline-block';

                    const capabilities = state.track.getCapabilities ? state.track.getCapabilities() : {};
                    if (capabilities && capabilities.torch) {
                        elements.flashOffBtn.disabled = false;
                        elements.flashOnBtn.disabled = false;
                        // é è¨­é¡¯ç¤ºé—œé–‰ç‹€æ…‹æŒ‰éˆ•
                        elements.flashOffBtn.style.display = 'inline-block';
                        elements.flashOnBtn.style.display = 'none';
                        state.flashOn = false;
                    } else {
                        elements.flashOffBtn.disabled = true;
                        elements.flashOnBtn.disabled = true;
                        elements.flashOffBtn.style.display = 'inline-block';
                        elements.flashOnBtn.style.display = 'none';
                    }

                    state.flashOn = false;
                    state.running = true;
                    state.isStarting = false;
                    elements.startBtn.disabled = false;
                    elements.resultCard.classList.remove('error', 'success');
                    elements.resultCard.textContent = 'æƒæä¸­ï¼Œè«‹å°‡æ¢ç¢¼ç½®æ–¼ç•«é¢ä¸­å¤®ä¸¦ä¿æŒç©©å®šã€‚';
                    elements.engineStatus.textContent = 'æƒæä¸­';
                    scanLoop();
                    log('ğŸ“½ï¸ æƒæè¿´åœˆå•Ÿå‹•');
                    updateEngineBadge('æƒæä¸­â€¦');
                } catch (error) {
                    log(`âŒ ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼š${error.message}`);
                    updateEngineBadge('å•Ÿå‹•å¤±æ•—');
                    elements.resultCard.classList.add('error');

                    let errorMessage = 'æ”å½±æ©Ÿå•Ÿå‹•å¤±æ•—';
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'âŒ æ”å½±æ©Ÿæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™ä½¿ç”¨æ”å½±æ©Ÿã€‚';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'âŒ æ‰¾ä¸åˆ°æ”å½±æ©Ÿè¨­å‚™ï¼Œè«‹ç¢ºèªæ”å½±æ©Ÿå·²é€£æ¥ã€‚';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = 'âŒ æ”å½±æ©Ÿæ­£è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ä¸­ã€‚';
                    } else {
                        errorMessage = `âŒ æ”å½±æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š${error.message}`;
                    }

                    elements.resultCard.textContent = errorMessage;
                    stopScanner(true);
                } finally {
                    // è‹¥æœªæˆåŠŸé€²å…¥ running ç‹€æ…‹ï¼Œè§£é™¤å•Ÿå‹•é–ä¸¦æ¢å¾©æŒ‰éˆ•
                    if (!state.running) {
                        state.isStarting = false;
                        elements.startBtn.disabled = false;
                    }
                }
            }

            function stopScanner(resetStatsToo = true) {
                if (state.isStopping) return;
                state.isStopping = true;
                state.running = false;
                state.detectionBusy = false;
                if (state.track) {
                    try { state.track.stop(); } catch (error) { log(`åœæ­¢ track å¤±æ•—ï¼š${error.message}`); }
                    state.track = null;
                }
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                    state.stream = null;
                }
                elements.preview.srcObject = null;
                updateEngineBadge('å·²åœæ­¢');
                elements.engineStatus.textContent = 'å·²åœæ­¢';
                // ç¢ºä¿åœæ­¢æŒ‰éˆ•åœ¨åœæ­¢å¾Œè¢«éš±è—èˆ‡åœç”¨
                elements.stopBtn.disabled = true;
                elements.stopBtn.style.display = 'none';
                elements.startBtn.style.display = 'inline-flex';
                elements.scannerControls.style.display = 'none';
                elements.flashOffBtn.disabled = true;
                elements.flashOnBtn.disabled = true;
                elements.flashOffBtn.style.display = 'none';
                // ç¢ºä¿ flashOnNew (id="flashOnNew") æŒ‰éˆ•å®Œå…¨éš±è—
                elements.flashOnBtn.style.display = 'none';
                // é¡å¤–ç¢ºä¿ä½¿ç”¨ CSS display:none éš±è— flashOnNew æŒ‰éˆ•
                const flashOnNewBtn = document.getElementById('flashOnNew');
                if (flashOnNewBtn) {
                    flashOnNewBtn.style.display = 'none';
                }
                state.flashOn = false;
                updateCameraStatusText();
                if (resetStatsToo) {
                    resetStats();
                }
                // åœæ­¢æµç¨‹å®Œæˆï¼Œè§£é™¤åœæ­¢é–
                state.isStopping = false;
                // ç¢ºä¿å¯å†æ¬¡å•Ÿå‹•
                elements.startBtn.disabled = false;
            }

            /**
             * é–‹å•Ÿæ‰‹é›»ç­’åŠŸèƒ½ - UI-first æ¨¡å¼
             * ç¬¬ä¸€æ­¥ï¼šç«‹å³æ›´æ–°UIç‹€æ…‹ï¼ˆé›¶å»¶é²ï¼‰
             * ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œç¡¬é«”æ“ä½œï¼ˆå¯èƒ½æœ‰å»¶é²ï¼‰
             */
            async function turnOnFlash() {
                if (!state.track || state.flashBusy) return;
                state.flashBusy = true;
                elements.flashOffBtn.disabled = true;
                elements.flashOnBtn.disabled = true;
                const capabilities = state.track.getCapabilities ? state.track.getCapabilities() : {};
                if (!capabilities || !capabilities.torch) {
                    state.flashBusy = false;
                    elements.flashOffBtn.disabled = false;
                    elements.flashOnBtn.disabled = false;
                    return;
                }

                // ç¬¬ä¸€æ­¥ï¼šç«‹å³æ›´æ–°UIç‹€æ…‹ï¼ˆé›¶å»¶é²åæ‡‰ï¼‰
                elements.flashOffBtn.style.display = 'none';
                elements.flashOnBtn.style.display = 'inline-block';
                state.flashOn = true;

                // ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œç¡¬é«”æ“ä½œï¼ˆå¯èƒ½æœ‰å»¶é²ï¼‰
                try {
                    await state.track.applyConstraints({ advanced: [{ torch: true }] });
                } catch (error) {
                    // å¦‚æœç¡¬é«”æ“ä½œå¤±æ•—ï¼Œæ¢å¾©UIç‹€æ…‹
                    elements.flashOffBtn.style.display = 'block';
                    elements.flashOnBtn.style.display = 'none';
                    state.flashOn = false;
                    log(`æ‰‹é›»ç­’é–‹å•Ÿå¤±æ•—ï¼š${error.message}`);
                } finally {
                    state.flashBusy = false;
                    elements.flashOffBtn.disabled = false;
                    elements.flashOnBtn.disabled = false;
                }
            }

            /**
             * é—œé–‰æ‰‹é›»ç­’åŠŸèƒ½ - UI-first æ¨¡å¼
             * ç¬¬ä¸€æ­¥ï¼šç«‹å³æ›´æ–°UIç‹€æ…‹ï¼ˆé›¶å»¶é²ï¼‰
             * ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œç¡¬é«”æ“ä½œï¼ˆå¯èƒ½æœ‰å»¶é²ï¼‰
             */
            async function turnOffFlash() {
                if (!state.track || state.flashBusy) return;
                state.flashBusy = true;
                elements.flashOffBtn.disabled = true;
                elements.flashOnBtn.disabled = true;
                const capabilities = state.track.getCapabilities ? state.track.getCapabilities() : {};
                if (!capabilities || !capabilities.torch) {
                    state.flashBusy = false;
                    elements.flashOffBtn.disabled = false;
                    elements.flashOnBtn.disabled = false;
                    return;
                }

                // ç¬¬ä¸€æ­¥ï¼šç«‹å³æ›´æ–°UIç‹€æ…‹ï¼ˆé›¶å»¶é²åæ‡‰ï¼‰
                elements.flashOffBtn.style.display = 'inline-block';
                elements.flashOnBtn.style.display = 'none';
                state.flashOn = false;

                // ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œç¡¬é«”æ“ä½œï¼ˆå¯èƒ½æœ‰å»¶é²ï¼‰
                try {
                    await state.track.applyConstraints({ advanced: [{ torch: false }] });
                } catch (error) {
                    // å¦‚æœç¡¬é«”æ“ä½œå¤±æ•—ï¼Œæ¢å¾©UIç‹€æ…‹
                    elements.flashOffBtn.style.display = 'none';
                    elements.flashOnBtn.style.display = 'block';
                    state.flashOn = true;
                    log(`æ‰‹é›»ç­’é—œé–‰å¤±æ•—ï¼š${error.message}`);
                } finally {
                    state.flashBusy = false;
                    elements.flashOffBtn.disabled = false;
                    elements.flashOnBtn.disabled = false;
                }
            }

            function updateCameraStatusText() {
                if (!state.track) {
                    elements.cameraStatus.textContent = 'å°šæœªå•Ÿå‹•';
                    return;
                }
                const settings = state.track.getSettings();
                elements.cameraStatus.textContent = `${settings.width || '?'}Ã—${settings.height || '?'} @ ${Math.round(settings.frameRate || 0)}fps`;
            }

            function bindEvents() {
                elements.startBtn.addEventListener('click', () => {
                    // é˜²æ­¢å¿«é€Ÿé€£é»é–‹å§‹
                    if (state.isStarting || state.running) return;
                    startScanner();
                });
                elements.stopBtn.addEventListener('click', () => {
                    // å…ˆç«‹å³éš±è—ä¸¦åœç”¨ã€Œåœæ­¢æƒæã€æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡é»æ“Š
                    elements.stopBtn.style.display = 'none';
                    elements.stopBtn.disabled = true;
                    // ç«‹å³éš±è— flashOnNew æŒ‰éˆ•
                    const flashOnNewBtn = document.getElementById('flashOnNew');
                    if (flashOnNewBtn) {
                        flashOnNewBtn.style.display = 'none';
                    }
                    elements.flashOnBtn.style.display = 'none';
                    // é˜²æ­¢å¿«é€Ÿé‡è¤‡åœæ­¢
                    if (!state.isStopping) {
                        stopScanner(false);
                    }
                });
                elements.flashOffBtn.addEventListener('click', turnOnFlash);
                elements.flashOnBtn.addEventListener('click', turnOffFlash);

                // å°‡é å°¾ç‰ˆæœ¬è™Ÿä½œç‚ºéš±è—æ¸¬è©¦æŒ‰éˆ•ï¼ˆæ–¼ç¶å®šæ™‚é‡æ–°æŸ¥æ‰¾ï¼Œé¿å…ä¸€é–‹å§‹æŠ“ä¸åˆ°ï¼‰
                const appVersionEl = elements.appVersion || document.querySelector('.app-version');
                if (appVersionEl) {
                    appVersionEl.style.cursor = 'pointer';
                    appVersionEl.title = '';
                    appVersionEl.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        triggerTestSuccessUI();
                    });
                    // éš±è—ç®¡ç†ï¼šé›™æ“Šç‰ˆæœ¬è™Ÿæ‰“é–‹ç®¡ç†é¢æ¿
                    appVersionEl.addEventListener('dblclick', (ev) => {
                        ev.preventDefault();
                        showAdminPanel();
                    });
                }

                window.addEventListener('resize', updateRoiOverlay);
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        stopScanner(false);
                    }
                });

                // æ»¾å‹•æ™‚éš±è— popover
                window.addEventListener('scroll', hidePopover);
                // è§¸æ§æ»‘å‹•æ™‚ä¹Ÿéš±è— popover
                window.addEventListener('touchmove', hidePopover);

                // ç•™è¨€ç‰ˆäº‹ä»¶
                initFeedbackSystem();
            }

            // ç°¡æ˜“éš±è—ç®¡ç†é¢æ¿ï¼šæ¸…ç©ºç•™è¨€æ¿ / æ¸…ç©ºç´¯è¨ˆè¨ªå•
            function showAdminPanel() {
                let panel = document.getElementById('adminPanel');
                if (panel) {
                    panel.style.display = 'block';
                    return;
                }
                panel = document.createElement('div');
                panel.id = 'adminPanel';
                panel.style.position = 'fixed';
                panel.style.right = '20px';
                panel.style.bottom = '20px';
                panel.style.zIndex = '10002';
                panel.style.background = 'rgba(17,24,39,0.95)';
                panel.style.border = '1px solid rgba(255,255,255,0.15)';
                panel.style.boxShadow = '0 10px 30px rgba(0,0,0,0.4)';
                panel.style.borderRadius = '12px';
                panel.style.padding = '12px';
                panel.style.minWidth = '220px';
                panel.style.backdropFilter = 'blur(8px)';

                panel.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;">
                        <strong style="color:#e5e7eb;font-size:14px;">ç®¡ç†å·¥å…·</strong>
                        <button id="adminCloseBtn" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;">âœ•</button>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <button id="btnClearMessages" style="padding:8px 10px;border:none;border-radius:8px;background:#374151;color:#e5e7eb;cursor:pointer;font-size:13px;text-align:left;">ğŸ—‘ï¸ æ¸…ç©ºç•™è¨€æ¿</button>
                        <button id="btnClearVisits" style="padding:8px 10px;border:none;border-radius:8px;background:#374151;color:#e5e7eb;cursor:pointer;font-size:13px;text-align:left;">â™»ï¸ æ¸…ç©ºç´¯è¨ˆè¨ªå•</button>
                        <button id="btnToggleDataset" style="padding:8px 10px;border:none;border-radius:8px;background:#374151;color:#e5e7eb;cursor:pointer;font-size:13px;text-align:left;">ğŸ§° åˆ‡æ›è³‡æ–™é›†ï¼ˆå®Œæ•´ç‰ˆ/ç²¾ç°¡ç‰ˆï¼‰</button>
                    </div>
                `;

                document.body.appendChild(panel);

                panel.querySelector('#adminCloseBtn').addEventListener('click', () => {
                    panel.style.display = 'none';
                });

                panel.querySelector('#btnClearMessages').addEventListener('click', () => {
                    if (window.clearAllMessages) {
                        window.clearAllMessages();
                    } else {
                        try {
                            localStorage.removeItem('bookPlanetMessages');
                            localStorage.removeItem('bookPlanetReplies');
                            const messagesDiv = document.getElementById('messages');
                            if (messagesDiv) messagesDiv.innerHTML = '';
                        } catch { }
                    }
                    alert('ç•™è¨€æ¿å·²æ¸…ç©º');
                });

                panel.querySelector('#btnClearVisits').addEventListener('click', () => {
                    if (window.clearVisitStats) {
                        window.clearVisitStats();
                    } else {
                        try {
                            localStorage.removeItem('bookScannerVisitCount');
                            localStorage.removeItem('bookScannerLastVisit');
                            localStorage.removeItem('bookScannerLocalDelta');
                            const el = document.getElementById('visitCount');
                            if (el) el.textContent = '0';
                        } catch { }
                    }
                    alert('ç´¯è¨ˆè¨ªå•å·²æ¸…ç©º');
                });

                // åˆ‡æ›è³‡æ–™é›†æ¨¡å¼ï¼ˆå„²å­˜åˆ° localStorageï¼Œä¸¦é‡æ–°æ•´ç†é é¢ï¼‰
                panel.querySelector('#btnToggleDataset').addEventListener('click', () => {
                    const current = localStorage.getItem('bookPlanetDatasetMode') || 'full';
                    const next = current === 'full' ? 'lite' : 'full';
                    localStorage.setItem('bookPlanetDatasetMode', next);
                    alert(`å·²åˆ‡æ›ç‚º ${next === 'lite' ? 'ç²¾ç°¡ç‰ˆ' : 'å®Œæ•´ç‰ˆ'} è³‡æ–™é›†ï¼Œå°‡é‡æ–°è¼‰å…¥é é¢ã€‚`);
                    location.reload();
                });
            }

            // === ç•™è¨€ç‰ˆåŠŸèƒ½ ===
            function initFeedbackSystem() {
                const feedbackBtn = document.getElementById('feedbackBtn');
                const feedbackSection = document.getElementById('feedbackSection');
                const closeFeedback = document.getElementById('closeFeedback');
                const msgForm = document.getElementById('msgForm');
                const messagesDiv = document.getElementById('messages');

                // åˆ‡æ›ç•™è¨€ç‰ˆé¡¯ç¤º/éš±è—
                function toggleFeedback() {
                    if (feedbackSection.style.display === 'none') {
                        feedbackSection.style.display = 'block';
                        // é¡¯ç¤ºç•™è¨€å€æ™‚æš«åœæƒæï¼Œé¿å… CPU ä½”ç”¨é€ æˆè¼¸å…¥é²æ»¯
                        try { stopScanner(false); } catch (e) { }
                        loadMessages();
                        initializeNickname();
                        // æ»¾å‹•åˆ°é é¢åº•éƒ¨ï¼Œé¡¯ç¤ºç•™è¨€ç‰ˆ
                        setTimeout(() => {
                            window.scrollTo({
                                top: document.body.scrollHeight,
                                behavior: 'smooth'
                            });
                        }, 100);
                    } else {
                        feedbackSection.style.display = 'none';
                    }
                }

                // è¼‰å…¥ç•™è¨€ï¼ˆå¾å¤–éƒ¨æª”æ¡ˆæˆ–æœ¬åœ°å„²å­˜ï¼‰
                // ä¸€æ¬¡æ€§é·ç§»ï¼šé¦–æ¬¡è¼‰å…¥è‡ªå‹•æ¸…æ‰èˆŠçš„æœ¬åœ°ç•™è¨€/å›è¦†ï¼Œé¿å…æ®˜ç•™
                function performMessageStorageMigration() {
                    try {
                        const FLAG = 'bookPlanetMessagesCleared_20251012';
                        if (!localStorage.getItem(FLAG)) {
                            localStorage.removeItem('bookPlanetMessages');
                            localStorage.removeItem('bookPlanetReplies');
                            localStorage.setItem(FLAG, '1');
                            console.log('[messages] Cleared local messages/replies by migration');
                        }
                    } catch (e) { /* ignore */ }
                }

                async function loadMessages() {
                    // ç¢ºä¿åœ¨è¼‰å…¥å‰åŸ·è¡Œæ¸…ç†ï¼ˆåƒ…ç¬¬ä¸€æ¬¡ï¼‰
                    performMessageStorageMigration();
                    // é¡¯ç¤ºè¼‰å…¥ä¸­
                    messagesDiv.innerHTML = `
                        <div class="loading-messages">
                            <p>ğŸ“¡ æ­£åœ¨è¼‰å…¥ç•™è¨€...</p>
                        </div>
                    `;

                    try {
                        let messages = [];

                        // å˜—è©¦å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥ç•™è¨€
                        try {
                            const response = await fetch('./data/messages.json');
                            if (response.ok) {
                                messages = await response.json();
                                log('âœ… å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥ç•™è¨€æˆåŠŸ');
                            } else {
                                throw new Error('å¤–éƒ¨æª”æ¡ˆä¸å­˜åœ¨');
                            }
                        } catch (fileError) {
                            // å¦‚æœå¤–éƒ¨æª”æ¡ˆå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜
                            log('â„¹ï¸ å¤–éƒ¨æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
                            const storedMessages = localStorage.getItem('bookPlanetMessages');
                            messages = storedMessages ? JSON.parse(storedMessages) : [];
                        }

                        // å¦‚æœæœ‰è¼‰å…¥å¤–éƒ¨æª”æ¡ˆï¼Œä¹Ÿåˆä½µæœ¬åœ°çš„æ–°ç•™è¨€
                        if (messages.length > 0) {
                            const localMessages = localStorage.getItem('bookPlanetMessages');
                            if (localMessages) {
                                const localParsed = JSON.parse(localMessages);
                                // æ‰¾å‡ºæœ¬åœ°ä½†ä¸åœ¨å¤–éƒ¨æª”æ¡ˆä¸­çš„ç•™è¨€ï¼ˆæ–°ç•™è¨€ï¼‰
                                const newLocalMessages = localParsed.filter(local =>
                                    !messages.some(external => external.id === local.id)
                                );
                                // å°‡æ–°ç•™è¨€æ”¾åœ¨æœ€å‰é¢
                                messages = [...newLocalMessages, ...messages];
                            }
                        }

                        // è¼‰å…¥ä¸¦åˆä½µå›è¦†
                        const storedReplies = localStorage.getItem('bookPlanetReplies');
                        if (storedReplies) {
                            const replies = JSON.parse(storedReplies);
                            // å°‡å›è¦†åŠ åˆ°å°æ‡‰çš„ç•™è¨€ä¸­
                            messages = messages.map(msg => {
                                const messageReplies = replies.filter(reply => {
                                    // æ¯”è¼ƒæ™‚éƒ½è½‰æˆå­—ä¸²ï¼Œå› ç‚ºparentIdå¯èƒ½æ˜¯æ•¸å­—æˆ–å­—ä¸²
                                    return String(reply.parentId) === String(msg.id || msg.time);
                                });
                                if (messageReplies.length > 0) {
                                    return { ...msg, replies: messageReplies };
                                }
                                return msg;
                            });
                        }

                        if (messages.length === 0) {
                            messagesDiv.innerHTML = `
                                <div class="empty-messages">
                                    <p>ğŸ’¬ é‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>
                                </div>
                            `;
                        } else {
                            messagesDiv.innerHTML = messages.map(msg => renderMessage(msg)).join('');
                            // ç¶å®šå›è¦†æŒ‰éˆ•äº‹ä»¶
                            bindReplyEvents();
                        }

                        log('âœ… ç•™è¨€è¼‰å…¥æˆåŠŸ');

                    } catch (error) {
                        log(`âŒ è¼‰å…¥ç•™è¨€å¤±æ•—ï¼š${error.message}`);

                        messagesDiv.innerHTML = `
                            <div class="message error-message" style="text-align: center; color: var(--error-light); background: rgba(220, 38, 38, 0.1); border-color: var(--error);">
                                <div class="message-content">
                                    <p style="margin-bottom: 8px;">âš ï¸ è¼‰å…¥ç•™è¨€æ™‚ç™¼ç”ŸéŒ¯èª¤</p>
                                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">è«‹ç¨å¾Œå†è©¦</p>
                                    <button class="reload-btn" onclick="loadMessages()">
                                        ğŸ”„ é‡æ–°è¼‰å…¥
                                    </button>
                                    <button class="clear-btn" title="æ¸…é™¤æ‰€æœ‰ç•™è¨€" onclick="window.clearAllMessages()">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }

                // æš´éœ²é‡æ–°è¼‰å…¥å‡½æ•¸åˆ°å…¨åŸŸ
                window.reloadMessages = loadMessages;

                // æ¸²æŸ“å–®ä¸€ç•™è¨€ï¼ˆåŒ…å«å›è¦†ï¼‰
                function renderMessage(msg, isReply = false) {
                    const replyHtml = msg.replies ? msg.replies.map(reply =>
                        `<div class="reply-message">${renderMessage(reply, true)}</div>`
                    ).join('') : '';

                    const replyButton = !isReply ? `
                        <div class="message-actions">
                            <button class="reply-btn" data-message-id="${msg.id || msg.time}">
                                ğŸ’¬ å›è¦†
                            </button>
                        </div>
                        <div class="reply-form" id="replyForm_${msg.id || msg.time}">
                            <div class="reply-input-group">
                                <input type="text" placeholder="ä½ çš„æš±ç¨±" id="replyName_${msg.id || msg.time}" value="${(() => {
                            const profile = localStorage.getItem('bookPlanetUserProfile');
                            return profile ? JSON.parse(profile).nickname : localStorage.getItem('bookPlanetUserNickname') || '';
                        })()}" required />
                            </div>
                            <div class="reply-input-group">
                                <textarea placeholder="å›è¦†å…§å®¹..." id="replyContent_${msg.id || msg.time}" required></textarea>
                            </div>
                            <div class="reply-actions">
                                <button class="reply-submit-btn" data-message-id="${msg.id || msg.time}">é€å‡ºå›è¦†</button>
                                <button class="reply-cancel-btn" data-message-id="${msg.id || msg.time}">å–æ¶ˆ</button>
                            </div>
                        </div>
                    ` : '';

                    // ç›´æ¥ç”Ÿæˆé ­åƒï¼Œç¢ºä¿ä¸€å®šæœ‰çµæœ
                    const avatarData = generateAvatar(msg.name || 'Anonymous');
                    const avatarHTML = createAvatarHTML(avatarData);

                    return `
                        <div class="message" data-id="${msg.id || msg.time}">
                            <div class="message-header">
                                <div class="user-info">
                                    ${avatarHTML}
                                    <span class="message-name">${escapeHtml(msg.name)}</span>
                                </div>
                                <span class="message-time">${formatTime(msg.time)}</span>
                            </div>
                            <p class="message-content">${escapeHtml(msg.content)}</p>
                            ${replyButton}
                            ${replyHtml}
                        </div>
                    `;
                }

                // åˆ‡æ›å›è¦†è¡¨å–®é¡¯ç¤º
                function toggleReplyForm(messageId) {
                    const form = document.getElementById(`replyForm_${messageId}`);
                    if (form) {
                        form.classList.toggle('show');
                        if (form.classList.contains('show')) {
                            // èšç„¦åˆ°åç¨±è¼¸å…¥æ¡†
                            const nameInput = document.getElementById(`replyName_${messageId}`);
                            if (nameInput) nameInput.focus();
                        }
                    }
                }

                // é€å‡ºå›è¦†
                function submitReply(messageId) {
                    const nameInput = document.getElementById(`replyName_${messageId}`);
                    const contentInput = document.getElementById(`replyContent_${messageId}`);

                    if (!nameInput || !contentInput) return;

                    const name = nameInput.value.trim();
                    const content = contentInput.value.trim();

                    if (!name || !content) {
                        alert('è«‹å¡«å¯«æš±ç¨±å’Œå›è¦†å…§å®¹');
                        return;
                    }

                    // å»ºç«‹å›è¦†ç‰©ä»¶
                    const reply = {
                        id: Date.now(),
                        name: name,
                        content: content,
                        time: new Date().toISOString(),
                        parentId: messageId
                    };

                    // æ›´æ–°ç”¨æˆ¶æš±ç¨±ï¼ˆå¦‚æœç”¨æˆ¶æ‰‹å‹•ä¿®æ”¹äº†ï¼‰
                    const currentStoredNickname = localStorage.getItem('bookPlanetUserNickname');
                    if (name !== currentStoredNickname) {
                        localStorage.setItem('bookPlanetUserNickname', name);
                    }

                    // å„²å­˜å›è¦†åˆ°æœ¬åœ°å„²å­˜
                    let storedReplies = localStorage.getItem('bookPlanetReplies');
                    const replies = storedReplies ? JSON.parse(storedReplies) : [];
                    replies.push(reply);
                    localStorage.setItem('bookPlanetReplies', JSON.stringify(replies));

                    // æ¸…ç©ºè¡¨å–®ä¸¦éš±è—
                    nameInput.value = '';
                    contentInput.value = '';
                    toggleReplyForm(messageId);

                    // é‡æ–°è¼‰å…¥ç•™è¨€
                    loadMessages();

                    log('âœ… å›è¦†å·²é€å‡º');
                }

                // ç¶å®šå›è¦†äº‹ä»¶ï¼ˆç”±æ–¼ä½¿ç”¨innerHTMLï¼Œéœ€è¦é‡æ–°ç¶å®šï¼‰
                function bindReplyEvents() {
                    // é€™å€‹å‡½æ•¸æš«æ™‚ä¸éœ€è¦åšä»€éº¼ï¼Œå› ç‚ºæˆ‘å€‘ä½¿ç”¨ onclick
                }

                // å°‡toggleReplyFormå’ŒsubmitReplyæš´éœ²åˆ°å…¨åŸŸ
                window.toggleReplyForm = toggleReplyForm;
                window.submitReply = submitReply;

                // åˆå§‹åŒ–ç¤ºç¯„ç•™è¨€ï¼ˆåƒ…åœ¨ç¬¬ä¸€æ¬¡è¨ªå•æ™‚ï¼‰
                function initSampleMessages() {
                    // å·²åœç”¨ç¤ºä¾‹ç•™è¨€æ³¨å…¥ï¼Œä¿æŒç•™è¨€å€ç‚ºç©ºã€‚
                    return;
                }

                // åŸ·è¡Œåˆå§‹åŒ–
                initSampleMessages();

                // æ¸…é™¤æ‰€æœ‰ç•™è¨€çš„åŠŸèƒ½ï¼ˆåƒ…ä¾›æ¸¬è©¦ä½¿ç”¨ï¼‰
                window.clearAllMessages = function () {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç•™è¨€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                        localStorage.removeItem('bookPlanetMessages');
                        localStorage.removeItem('bookPlanetReplies');
                        loadMessages();
                        alert('æ‰€æœ‰ç•™è¨€å·²æ¸…é™¤');
                    }
                };

                // é—œé–‰ç•™è¨€å€
                window.closeFeedback = function () {
                    const feedbackSection = document.getElementById('feedbackSection');
                    if (feedbackSection) {
                        feedbackSection.style.display = 'none';
                    }
                };

                // åå­—åˆ†é…ç³»çµ±
                const nickNames = [
                    'å‰ä¼Šå¡è›™', 'å“†å•¦Jå¤¢', 'å­«é™¸ç©º', 'ç‚­æ²»ç‹¼', 'è‚éµäºº', 'ç± è²“', 'é–é¾',
                    'å¥‡èŠ½', 'è¬è±†å­', 'é˜¿å¦®äº', 'æ»·å¤«', 'æ’•ç´™ç‹', 'è¾£å¸ƒå¸ƒ', 'å²åŠªå—¶',
                    'å¡çš®çˆ¸æ‹‰', 'å²ç¬›å¥‡', 'é¼»å¡ä¸˜'
                ];

                // é ­åƒç³»çµ± (ä½¿ç”¨é¡è‰²+å­—æ¯) - æ·±è‰²ç‰ˆæœ¬
                const avatarColors = [
                    '#E53E3E', '#319795', '#3182CE', '#DD6B20', '#38A169',
                    '#D69E2E', '#9F7AEA', '#3182CE', '#ED8936', '#48BB78',
                    '#E53E3E', '#3182CE', '#D69E2E', '#4299E1', '#38A169',
                    '#E53E3E', '#9F7AEA', '#319795', '#D69E2E', '#4299E1'
                ];

                function generateAvatar(name) {
                    if (!name || name.length === 0) {
                        return { char: '?', color: '#6B7280' };
                    }
                    const firstChar = name.charAt(0).toUpperCase();
                    const colorIndex = (name.charCodeAt(0) + name.length) % avatarColors.length;
                    const color = avatarColors[colorIndex];
                    return { char: firstChar, color: color };
                }

                // ç°¡å–®çš„é ­åƒHTMLç”Ÿæˆå‡½æ•¸
                function createAvatarHTML(avatarData) {
                    if (!avatarData || !avatarData.char || !avatarData.color) {
                        return '<div class="user-avatar" style="background-color: #6B7280;">?</div>';
                    }
                    return `<div class="user-avatar" style="background-color: ${avatarData.color}">${avatarData.char}</div>`;
                } function generateUserProfile() {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åˆ†é…éçš„ä½¿ç”¨è€…è³‡æ–™
                    let userProfile = localStorage.getItem('bookPlanetUserProfile');

                    if (userProfile) {
                        return JSON.parse(userProfile);
                    }

                    // ç²å–å·²ä½¿ç”¨çš„æš±ç¨±çµ„åˆ
                    const usedNicknames = JSON.parse(localStorage.getItem('bookPlanetUsedNicknames') || '[]');

                    // ç”Ÿæˆå¯ç”¨çš„æ•¸å­—ï¼ˆ10-99ï¼Œæ’é™¤åŒ…å«4çš„æ•¸å­—ï¼‰
                    const availableNumbers = [];
                    for (let i = 10; i <= 99; i++) {
                        if (!i.toString().includes('4')) {
                            availableNumbers.push(i);
                        }
                    }

                    // å˜—è©¦æ‰¾åˆ°å¯ç”¨çš„æš±ç¨±çµ„åˆ
                    let attempts = 0;
                    let nickname;

                    while (attempts < 1000) {  // é˜²æ­¢ç„¡é™å¾ªç’°
                        const randomName = nickNames[Math.floor(Math.random() * nickNames.length)];
                        const randomNumber = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                        nickname = randomName + randomNumber;

                        if (!usedNicknames.includes(nickname)) {
                            break;
                        }
                        attempts++;
                    }

                    // å¦‚æœæ‰€æœ‰çµ„åˆéƒ½ç”¨å®Œäº†ï¼Œå°±ç”¨æ™‚é–“æˆ³
                    if (attempts >= 1000) {
                        nickname = 'è¨ªå®¢' + Date.now().toString().slice(-4);
                    }

                    // æ ¹æ“šæš±ç¨±ç”Ÿæˆé ­åƒ
                    const avatarData = generateAvatar(nickname);

                    // å»ºç«‹ä½¿ç”¨è€…è³‡æ–™
                    const newUserProfile = {
                        nickname: nickname,
                        avatar: avatarData
                    };

                    // ä¿å­˜ä½¿ç”¨è€…è³‡æ–™
                    localStorage.setItem('bookPlanetUserProfile', JSON.stringify(newUserProfile));
                    localStorage.setItem('bookPlanetUserNickname', nickname); // å‘ä¸‹ç›¸å®¹
                    usedNicknames.push(nickname);
                    localStorage.setItem('bookPlanetUsedNicknames', JSON.stringify(usedNicknames));

                    return newUserProfile;
                }

                function initializeNickname() {
                    const nameInput = document.getElementById('name');
                    if (nameInput) {
                        const userProfile = generateUserProfile();
                        nameInput.value = userProfile.nickname;
                        nameInput.placeholder = userProfile.nickname;
                    }
                }

                // å–å¾—ä½¿ç”¨è€…é ­åƒ
                function getUserAvatar(username) {
                    // é¦–å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰ä½¿ç”¨è€…
                    const userProfile = localStorage.getItem('bookPlanetUserProfile');
                    if (userProfile) {
                        const profile = JSON.parse(userProfile);
                        if (profile.nickname === username) {
                            return profile.avatar;
                        }
                    }

                    // æª¢æŸ¥æ˜¯å¦åœ¨ä½¿ç”¨è€…é ­åƒæ˜ å°„ä¸­
                    const avatarMappings = JSON.parse(localStorage.getItem('bookPlanetAvatarMappings') || '{}');
                    if (avatarMappings[username]) {
                        return avatarMappings[username];
                    }

                    // ç‚ºæ–°ä½¿ç”¨è€…ç”Ÿæˆé ­åƒ
                    const avatarData = generateAvatar(username);
                    avatarMappings[username] = avatarData;
                    localStorage.setItem('bookPlanetAvatarMappings', JSON.stringify(avatarMappings));

                    return avatarData;
                }

                // é€å‡ºç•™è¨€
                function submitMessage(e) {
                    e.preventDefault();

                    const name = document.getElementById('name').value.trim();
                    const content = document.getElementById('content').value.trim();

                    if (!name || !content) {
                        showAlert('è«‹å¡«å¯«æš±ç¨±å’Œç•™è¨€å…§å®¹', 'warning');
                        return;
                    }

                    if (name.length > 50) {
                        showAlert('æš±ç¨±ä¸èƒ½è¶…é 50 å€‹å­—ç¬¦', 'warning');
                        return;
                    }

                    if (content.length > 500) {
                        showAlert('ç•™è¨€å…§å®¹ä¸èƒ½è¶…é 500 å€‹å­—ç¬¦', 'warning');
                        return;
                    }

                    // é¡¯ç¤ºé€å‡ºä¸­ç‹€æ…‹
                    const submitBtn = document.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'ğŸ“¤ é€å‡ºä¸­...';
                    submitBtn.disabled = true;

                    try {
                        // æ–°å¢ç•™è¨€
                        const newMessage = {
                            id: Date.now(), // ç°¡å–®çš„IDç”Ÿæˆ
                            name: name,
                            content: content,
                            time: new Date().toISOString()
                        };

                        // åŒæ™‚å„²å­˜åˆ°æœ¬åœ°å„²å­˜ï¼ˆä½œç‚ºå‚™æ´ï¼‰
                        const storedMessages = localStorage.getItem('bookPlanetMessages');
                        const localMessages = storedMessages ? JSON.parse(storedMessages) : [];
                        localMessages.unshift(newMessage);
                        localStorage.setItem('bookPlanetMessages', JSON.stringify(localMessages));

                        // æ›´æ–°ç”¨æˆ¶æš±ç¨±ï¼ˆå¦‚æœç”¨æˆ¶æ‰‹å‹•ä¿®æ”¹äº†ï¼‰
                        const currentStoredNickname = localStorage.getItem('bookPlanetUserNickname');
                        if (name !== currentStoredNickname) {
                            localStorage.setItem('bookPlanetUserNickname', name);
                        }

                        // é‡ç½®è¡¨å–®ä¸¦é‡æ–°è¼‰å…¥ç•™è¨€
                        msgForm.reset();
                        loadMessages();

                        // é‡æ–°è¨­å®šæš±ç¨±åˆ°è¼¸å…¥æ¡†
                        setTimeout(() => {
                            const nameInput = document.getElementById('name');
                            if (nameInput) {
                                nameInput.value = name;
                            }
                        }, 100);

                        log('âœ… ç•™è¨€å·²å„²å­˜åˆ°æœ¬åœ°ï¼Œè«‹æ‰‹å‹•æ›´æ–° data/messages.json æª”æ¡ˆ');

                        // é¡¯ç¤ºæç¤ºè¨Šæ¯
                        showAlert('ç•™è¨€å·²é€å‡ºï¼', 'success');
                        showFeedbackSuccess();

                    } catch (error) {
                        log(`âŒ é€å‡ºç•™è¨€å¤±æ•—ï¼š${error.message}`);
                        showAlert('ç•™è¨€é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');

                    } finally {
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }

                // é¡¯ç¤ºæç¤ºè¨Šæ¯
                function showAlert(message, type = 'info') {
                    // ç§»é™¤èˆŠçš„æç¤º
                    const existingAlert = document.querySelector('.feedback-alert');
                    if (existingAlert) {
                        existingAlert.remove();
                    }

                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'feedback-alert';
                    alertDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10001;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: 500;
                        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                        animation: slideInRight 0.3s ease-out;
                        max-width: 300px;
                        word-wrap: break-word;
                    `;

                    // æ ¹æ“šé¡å‹è¨­å®šæ¨£å¼
                    switch (type) {
                        case 'error':
                            alertDiv.style.background = 'var(--error)';
                            alertDiv.style.color = 'white';
                            break;
                        case 'warning':
                            alertDiv.style.background = 'var(--warning)';
                            alertDiv.style.color = 'white';
                            break;
                        case 'success':
                            alertDiv.style.background = 'var(--success)';
                            alertDiv.style.color = 'white';
                            break;
                        default:
                            alertDiv.style.background = 'var(--primary)';
                            alertDiv.style.color = 'white';
                    }

                    alertDiv.textContent = message;
                    document.body.appendChild(alertDiv);

                    // è‡ªå‹•ç§»é™¤
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.style.animation = 'slideOutRight 0.3s ease-in';
                            setTimeout(() => alertDiv.remove(), 300);
                        }
                    }, 4000);
                }

                // é¡¯ç¤ºæˆåŠŸæç¤º
                function showFeedbackSuccess() {
                    const submitBtn = document.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;

                    submitBtn.textContent = 'âœ… ç•™è¨€æˆåŠŸï¼';
                    submitBtn.style.background = 'var(--success)';

                    setTimeout(() => {
                        submitBtn.textContent = originalText;
                        submitBtn.style.background = 'var(--primary)';
                    }, 2000);
                }

                // HTML è½‰ç¾©ï¼ˆé˜² XSSï¼‰
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                // æ™‚é–“æ ¼å¼åŒ–
                function formatTime(timeStr) {
                    try {
                        return new Date(timeStr).toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return 'æ™‚é–“ä¸æ˜';
                    }
                }

                // ç¶å®šäº‹ä»¶
                if (feedbackBtn) {
                    feedbackBtn.addEventListener('click', toggleFeedback);
                }

                if (closeFeedback) {
                    closeFeedback.addEventListener('click', () => {
                        feedbackSection.style.display = 'none';
                    });
                }

                if (msgForm) {
                    msgForm.addEventListener('submit', submitMessage);
                }

                // æ”¹å–„è¼¸å…¥æ¡†é»æ“Šåæ‡‰ï¼šä¸€èšç„¦å°±æš«åœæƒæï¼Œé™ä½ä¸»åŸ·è¡Œç·’è² è¼‰
                const nameInputEl = document.getElementById('name');
                const contentInputEl = document.getElementById('content');
                if (nameInputEl) {
                    nameInputEl.addEventListener('focus', () => {
                        try { stopScanner(false); } catch (e) { }
                    });
                }
                if (contentInputEl) {
                    contentInputEl.addEventListener('focus', () => {
                        try { stopScanner(false); } catch (e) { }
                    });
                }

                // æ·»åŠ äº‹ä»¶å§”æ‰˜å„ªåŒ–ç•™è¨€é»æ“Šæ€§èƒ½
                if (messagesDiv) {
                    messagesDiv.addEventListener('click', (event) => {
                        const target = event.target;

                        // è™•ç†ç•™è¨€åç¨±é»æ“Š
                        if (target.classList.contains('message-name')) {
                            const messageElement = target.closest('.message');
                            const messageId = messageElement.getAttribute('data-id');
                            if (messageId) {
                                toggleReplyForm(messageId);
                            }
                        }

                        // è™•ç†ç•™è¨€å…§å®¹é»æ“Š
                        if (target.classList.contains('message-content')) {
                            const messageElement = target.closest('.message');
                            const messageId = messageElement.getAttribute('data-id');
                            if (messageId) {
                                toggleReplyForm(messageId);
                            }
                        }

                        // è™•ç†å›è¦†æŒ‰éˆ•é»æ“Š
                        if (target.classList.contains('reply-btn')) {
                            const messageElement = target.closest('.message');
                            const messageId = messageElement.getAttribute('data-id');
                            if (messageId) {
                                toggleReplyForm(messageId);
                            }
                        }

                        // è™•ç†é€å‡ºå›è¦†æŒ‰éˆ•é»æ“Š
                        if (target.classList.contains('reply-submit-btn')) {
                            const messageElement = target.closest('.message');
                            const messageId = messageElement.getAttribute('data-id');
                            if (messageId) {
                                submitReply(messageId);
                            }
                        }

                        // è™•ç†å–æ¶ˆå›è¦†æŒ‰éˆ•é»æ“Š
                        if (target.classList.contains('reply-cancel-btn')) {
                            const messageElement = target.closest('.message');
                            const messageId = messageElement.getAttribute('data-id');
                            if (messageId) {
                                toggleReplyForm(messageId);
                            }
                        }
                    });
                }
            }

            // ç­‰å¾… DOM å®Œå…¨è¼‰å…¥
            document.addEventListener('DOMContentLoaded', async () => {
                // é¦–å…ˆè¼‰å…¥è¨­å®šæª”æ¡ˆ
                await loadScanConfig();

                initDetectors();
                bindEvents();
                loadBookList();
                initializeNickname();

                // æª¢æŸ¥åŸºæœ¬åŠŸèƒ½
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    elements.resultCard.classList.add('error');
                    elements.resultCard.textContent = 'âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´æ”å½±æ©ŸåŠŸèƒ½ï¼Œè«‹ä½¿ç”¨è¼ƒæ–°çš„ç€è¦½å™¨ã€‚';
                    elements.startBtn.disabled = true;
                }
            });
        })();
    </script>

    <!-- é é¢åº•éƒ¨è³‡è¨Š -->
    <footer class="page-footer">
        <div class="footer-content">
            <!-- ä½¿ç”¨çµ±è¨ˆå€å¡Š -->
            <div class="stats-section">
                <h3>ğŸ“Š ä½¿ç”¨çµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="visitCount">è¼‰å…¥ä¸­...</span>
                        <span class="stat-label">ç´¯è¨ˆè¨ªå•</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="scanCount">0</span>
                        <span class="stat-label">ç´¯è¨ˆæƒæ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="bookCount">è¼‰å…¥ä¸­...</span>
                        <span class="stat-label">æ›¸ç±è³‡æ–™åº«</span>
                    </div>
                </div>
            </div>
            <!-- è¯ç¹«ä½œè€…å€å¡Š -->
            <div class="contact-section">
                <div class="contact-links">
                    <button id="feedbackBtn" class="contact-item feedback-btn">ğŸ’¡ ç•™è¨€å›é¥‹</button>
                    <a href="mailto:colinjen88@gmail.com?subject=å¸ƒå¯æƒæå™¨" class="contact-item">â­ å¯«ä¿¡çµ¦ä½œè€…</a>
                </div>
            </div>

            <!-- ç‰ˆæ¬Šè³‡è¨Š -->
            <div class="copyright-section">
                <div class="app-info">
                    <span class="app-title">ğŸ“˜ æŸ¥è©¢å¸ƒå¯æ˜Ÿçƒæ¢ç¢¼å°å·¥å…·</span>
                    <span class="app-version">v1.1</span>
                </div>
                <div class="copyright-text">
                    <span>Â© 2025 æ•™è‚²ç”¨é€” | Made with â¤ï¸ in Taiwan</span>
                    <span class="update-time">æœ€å¾Œæ›´æ–°ï¼š2025å¹´10æœˆ9æ—¥</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- ç•™è¨€ç‰ˆå€å¡Š (åˆå§‹éš±è—ï¼Œæ”¾ç½®åœ¨æœ€å¾Œé¢) -->
    <div class="feedback-section" id="feedbackSection" style="display: none; margin-top: 100px;">
        <div class="feedback-container">
            <button class="feedback-close-btn" onclick="closeFeedback()" title="é—œé–‰ç•™è¨€å€">âœ• é—œé–‰ç•™è¨€</button>
            <h3>ğŸ’¬ ç•™è¨€å›é¥‹</h3>
            <div class="feedback-form">
                <form id="msgForm">
                    <div class="input-group">
                        <input type="text" id="name" placeholder="ä½ çš„æš±ç¨±" required />
                    </div>
                    <div class="input-group">
                        <textarea id="content" rows="4" placeholder="è«‹ç•™ä¸‹ä½ çš„å»ºè­°æˆ–å›é¥‹..." required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">ğŸ“ é€å‡ºç•™è¨€</button>
                        <button type="button" id="closeFeedback" class="close-btn">âœ• é—œé–‰</button>
                    </div>
                </form>
            </div>
            <div class="messages-container">
                <h4>ğŸ“‹ æœ€æ–°ç•™è¨€</h4>
                <div id="messages" class="messages-list"></div>
            </div>
        </div>
    </div>

    <script>
        // === çµ±è¨ˆåŠŸèƒ½æ¨¡çµ„ ===
        (function () {
            // å¸¸æ•¸å®šç¾©
            const VISIT_COOLDOWN_MS = 15 * 60 * 1000; // 15åˆ†é˜å†·å»æ™‚é–“
            const STORAGE_KEYS = {
                visitCount: 'bookScannerVisitCount',
                lastVisit: 'bookScannerLastVisit'
            };

            // å…§éƒ¨ç‹€æ…‹ï¼ˆç´¯è¨ˆæƒææ•¸ä½¿ç”¨ localStorage æŒä¹…åŒ–ï¼‰
            const STORAGE_SCAN_TOTAL = 'bookScannerTotalScanCount';
            let scanCount = parseInt(localStorage.getItem(STORAGE_SCAN_TOTAL) || '0');

            /**
             * æ›´æ–°æƒææ¬¡æ•¸
             */
            function updateScanCount() {
                scanCount++;
                localStorage.setItem(STORAGE_SCAN_TOTAL, String(scanCount));
                const element = document.getElementById('scanCount');
                if (element) element.textContent = scanCount.toLocaleString();
            }

            /**
             * è¼‰å…¥ä¸¦é¡¯ç¤ºçµ±è¨ˆè³‡æ–™ï¼ˆå¾å¤–éƒ¨æª”æ¡ˆæˆ–æœ¬åœ°å„²å­˜ï¼‰
             */
            async function loadStats() {
                let remoteVisitBase = 0;
                const disableRemoteBase = localStorage.getItem('bookScannerDisableRemoteBase') === '1';
                if (!disableRemoteBase) {
                    try {
                        // å˜—è©¦å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥çµ±è¨ˆè³‡æ–™
                        const response = await fetch('./data/stats.json');
                        if (response.ok) {
                            const stats = await response.json();
                            remoteVisitBase = parseInt(stats.visitCount || 0) || 0;
                            console.log('âœ… å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥çµ±è¨ˆè³‡æ–™æˆåŠŸ');
                        }
                    } catch (error) {
                        console.log('â„¹ï¸ å¤–éƒ¨æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°çµ±è¨ˆ');
                    }
                } else {
                    console.log('â„¹ï¸ å·²åœç”¨é ç«¯è¨ªå•åŸºæº–ï¼ˆæ¸…ç©ºå¾Œçš„æœ¬åœ°æ¨¡å¼ï¼‰');
                }

                // ä½¿ç”¨é ç«¯åŸºæº–æ•¸ï¼ˆè‹¥æœ‰ï¼‰+ æœ¬åœ° 15 åˆ†é˜å†·å»ç´¯åŠ 
                updateVisitCountLocal(remoteVisitBase);
            }

            /**
             * ç²å–ä¸¦é¡¯ç¤ºè¨ªå•æ¬¡æ•¸ï¼ˆé¿å…15åˆ†é˜å…§é‡è¤‡ç´¯è¨ˆï¼‰- æœ¬åœ°ç‰ˆæœ¬
             */
            function updateVisitCountLocal(baseCount = 0) {
                const now = Date.now();
                const lastVisitTime = parseInt(localStorage.getItem(STORAGE_KEYS.lastVisit) || '0');
                const localDeltaKey = 'bookScannerLocalDelta';
                let localDelta = parseInt(localStorage.getItem(localDeltaKey) || '0');

                // è‹¥æä¾›é ç«¯åŸºæº–ï¼Œä½¿ç”¨æœ¬åœ°å¢é‡æ©Ÿåˆ¶ï¼›å¦å‰‡ç¶­æŒèˆŠé‚è¼¯ï¼ˆç›¸å®¹ï¼‰
                if (baseCount > 0) {
                    if (!lastVisitTime || (now - lastVisitTime) > VISIT_COOLDOWN_MS) {
                        localDelta += 1;
                        localStorage.setItem(localDeltaKey, localDelta);
                        localStorage.setItem(STORAGE_KEYS.lastVisit, now.toString());
                    }
                    const effective = baseCount + localDelta;
                    const el = document.getElementById('visitCount');
                    if (el) el.textContent = effective.toLocaleString();
                    return;
                }

                // èˆŠç›¸å®¹é‚è¼¯ï¼ˆæ²’æœ‰é ç«¯åŸºæº–æ™‚ï¼‰
                const visitCount = parseInt(localStorage.getItem(STORAGE_KEYS.visitCount) || '0');
                if (!lastVisitTime || (now - lastVisitTime) > VISIT_COOLDOWN_MS) {
                    const newVisitCount = visitCount + 1;
                    localStorage.setItem(STORAGE_KEYS.visitCount, newVisitCount);
                    localStorage.setItem(STORAGE_KEYS.lastVisit, now.toString());
                    const element = document.getElementById('visitCount');
                    if (element) element.textContent = newVisitCount.toLocaleString();
                } else {
                    const element = document.getElementById('visitCount');
                    if (element) element.textContent = visitCount.toLocaleString();
                }
            }

            // æ›´æ–°æ›¸ç±è³‡æ–™åº«æ•¸é‡
            function updateBookCount() {
                // ç›£è½æ›¸ç±è¼‰å…¥å®Œæˆäº‹ä»¶
                window.addEventListener('booksLoaded', function (event) {
                    const bookCount = event.detail.count;
                    document.getElementById('bookCount').textContent = bookCount.toLocaleString();
                });

                // ç›£è½æ›¸ç±è¼‰å…¥å¤±æ•—äº‹ä»¶
                window.addEventListener('booksLoadError', function () {
                    document.getElementById('bookCount').textContent = 'è¼‰å…¥å¤±æ•—';
                });

                // å‚™ç”¨æª¢æŸ¥æ©Ÿåˆ¶ï¼ˆä»¥é˜²äº‹ä»¶ç³»çµ±å¤±æ•—ï¼‰
                const checkBookList = () => {
                    if (window.state && window.state.bookList && window.state.bookList.length > 0) {
                        document.getElementById('bookCount').textContent = window.state.bookList.length.toLocaleString();
                        return true;
                    }
                    return false;
                };

                // å»¶é²æª¢æŸ¥ï¼Œç¢ºä¿èƒ½æ•æ‰åˆ°æ›¸ç±æ•¸é‡
                setTimeout(() => {
                    if (!checkBookList()) {
                        // å¦‚æœé‚„æ˜¯æ²’æœ‰æ•¸æ“šï¼Œå˜—è©¦ç›´æ¥è¼‰å…¥
                        fetch('data/books_list.json')
                            .then(response => response.json())
                            .then(bookList => {
                                document.getElementById('bookCount').textContent = bookList.length.toLocaleString();
                            })
                            .catch(error => {
                                console.log('è¼‰å…¥æ›¸ç±æ•¸é‡å¤±æ•—:', error);
                                document.getElementById('bookCount').textContent = 'è¼‰å…¥å¤±æ•—';
                            });
                    }
                }, 2000);
            }

            // ç›£è½æƒææˆåŠŸäº‹ä»¶
            document.addEventListener('DOMContentLoaded', function () {
                loadStats();
                updateBookCount();
                // åˆå§‹åŒ–ç´¯è¨ˆæƒææ•¸é¡¯ç¤º
                const scanEl = document.getElementById('scanCount');
                if (scanEl) scanEl.textContent = scanCount.toLocaleString();

                // ç›£è½æƒææˆåŠŸï¼ˆç•¶çµæœå¡ç‰‡é¡¯ç¤ºæˆåŠŸæ™‚ï¼‰
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.classList.contains('success')) {
                                // æ¸¬è©¦æ¨¡å¼ä¸è¨ˆæ•¸
                                if (window.__TEST_SUCCESS) {
                                    window.__TEST_SUCCESS = false;
                                    return;
                                }
                                updateScanCount();
                            }
                        }
                    });
                });

                const resultCard = document.getElementById('resultCard');
                if (resultCard) {
                    observer.observe(resultCard, { attributes: true });
                }
            });

            // å°å‡ºï¼šæ¸…ç©ºç´¯è¨ˆè¨ªå•èˆ‡æƒæ
            window.clearVisitStats = function () {
                try {
                    localStorage.removeItem('bookScannerVisitCount');
                    localStorage.removeItem('bookScannerLastVisit');
                    localStorage.removeItem('bookScannerLocalDelta');
                    localStorage.setItem('bookScannerDisableRemoteBase', '1');
                    localStorage.removeItem('bookScannerTotalScanCount');
                } catch { }
                const visitEl = document.getElementById('visitCount');
                if (visitEl) visitEl.textContent = '0';
                const scanEl = document.getElementById('scanCount');
                if (scanEl) scanEl.textContent = '0';
            }
        })();
    </script>
</body>

</html>