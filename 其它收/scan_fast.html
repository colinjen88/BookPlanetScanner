<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>é«˜æˆåŠŸç‡æƒæå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 10px;
            background: #f5f5f5;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        .btn {
            padding: 20px 30px;
            font-size: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            width: 200px;
        }

        #flashBtn {
            background: #FF9800;
            font-size: 24px;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        #reader {
            width: 100%;
            margin: 10px auto;
        }

        #result {
            margin: 15px auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .2);
            font-size: 16px;
            line-height: 1.8;
        }

        .big-text {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .success {
            background: #e8f5e8 !important;
            color: #2e7d32;
        }

        .error {
            background: #ffebee !important;
            color: #c62828;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="color: #4CAF50;">ğŸ“š è¶…ç´šæƒæå™¨</h1>
        <button class="btn" id="startBtn">ğŸ” é–‹å§‹æƒæ</button>
        <button class="btn" id="flashBtn" style="display:none">ğŸ’¡ æ‰‹é›»ç­’</button>
        <button class="btn" id="stopBtn" style="display:none; background:#f44336">â¹ï¸ åœæ­¢</button>
        <button class="btn" id="restartBtn" style="display:none; background:#2196F3">ğŸ”„ é‡æ–°é–‹å§‹</button>

        <div id="reader" style="display:none"></div>
        <div id="result" class="big-text">æº–å‚™æƒææ›¸ç±æ¢ç¢¼</div>
    </div>

    <script>
        let bookList = [];
        let html5Qr = null;
        let running = false;
        let scanned = false;
        let flashOn = false;
        let stream = null;
        let scanCount = 0;

        // è¼‰å…¥æ›¸å–®
        fetch('books_list.json')
            .then(res => res.json())
            .then(data => {
                bookList = data;
                document.getElementById('result').innerHTML = `
                    <div class="big-text">ğŸ“– å·²è¼‰å…¥ ${data.length} æœ¬æ›¸</div>
                    <div>é»æ“Šé–‹å§‹æƒææŒ‰éˆ•</div>
                `;
            })
            .catch(error => {
                document.getElementById('result').innerHTML = '<div class="error big-text">æ›¸å–®è¼‰å…¥å¤±æ•—</div>';
            });

        // æ¥µç°¡æ¢ç¢¼è™•ç†
        function processBarcode(rawCode) {
            const cleaned = rawCode.replace(/\D/g, '');

            // è™•ç†è¤‡åˆæ¢ç¢¼ (EAN-13 + EAN-5)
            if (cleaned.length === 18) return cleaned.substring(0, 13);
            if (cleaned.length === 15) return cleaned.substring(0, 10);
            if (cleaned.length > 13) return cleaned.substring(0, 13);

            return cleaned;
        }

        function checkBook(isbn) {
            const processedIsbn = processBarcode(isbn);
            console.log('è™•ç†æ¢ç¢¼:', isbn, '->', processedIsbn);

            if (processedIsbn.length < 8) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <div class="big-text">âš ï¸ æ¢ç¢¼å¤ªçŸ­</div>
                        <div>å¯èƒ½æ˜¯åƒ¹æ ¼ç¢¼ï¼Œè«‹æƒæ ISBN æ¢ç¢¼</div>
                        <div>æƒæåˆ°: ${isbn}</div>
                    </div>
                `;
                return;
            }

            const found = bookList.find(book => {
                if (!book.ISBN) return false;
                const bookIsbn = book.ISBN.replace(/\D/g, '');
                return bookIsbn === processedIsbn;
            });

            if (found) {
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <div class="big-text">ğŸ‰ æ‰¾åˆ°äº†ï¼</div>
                        <div style="font-size: 20px; margin: 10px 0;"><strong>${found.æ›¸å}</strong></div>
                        <hr>
                        <div>ISBN: ${found.ISBN}</div>
                        <div>é©åˆ: ${found.é©åˆå°è±¡ || 'æœªæ¨™ç¤º'}</div>
                        <div style="margin-top: 15px; padding: 10px; background: #4caf50; color: white; border-radius: 8px;">
                            âœ… é€™æ˜¯å¸ƒå¯æ˜Ÿçƒé¸æ›¸
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <div class="big-text">âŒ ä¸åœ¨æ›¸å–®ä¸­</div>
                        <div>é€™æœ¬æ›¸ä¸æ˜¯å¸ƒå¯æ˜Ÿçƒé¸æ›¸</div>
                        <hr>
                        <div>æƒæåˆ°çš„æ¢ç¢¼: ${isbn}</div>
                        <div>è™•ç†å¾Œçš„ ISBN: ${processedIsbn}</div>
                    </div>
                `;
            }
        }

        // æ‰‹é›»ç­’åŠŸèƒ½
        async function toggleFlash() {
            try {
                if (!stream) {
                    // å¦‚æœæ²’æœ‰ä¸²æµï¼Œå˜—è©¦ç²å–
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                }

                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.torch) {
                    flashOn = !flashOn;
                    await track.applyConstraints({
                        advanced: [{ torch: flashOn }]
                    });

                    const flashBtn = document.getElementById('flashBtn');
                    if (flashOn) {
                        flashBtn.textContent = 'ğŸ’¡ é—œç‡ˆ';
                        flashBtn.style.background = '#f44336';
                    } else {
                        flashBtn.textContent = 'ğŸ’¡ æ‰‹é›»ç­’';
                        flashBtn.style.background = '#FF9800';
                    }
                } else {
                    document.getElementById('flashBtn').textContent = 'âŒ ä¸æ”¯æ´';
                }
            } catch (error) {
                console.error('æ‰‹é›»ç­’éŒ¯èª¤:', error);
            }
        }

        async function startScan() {
            if (running) return;

            running = true;
            scanned = false;
            scanCount = 0;

            // æ›´æ–°ç•Œé¢
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('flashBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'block';

            document.getElementById('result').innerHTML = `
                <div style="background: linear-gradient(135deg, #4caf50, #81c784); color: white; padding: 20px; border-radius: 15px; margin: 10px 0;">
                    <div class="big-text">ğŸ¯ é«˜é€Ÿæƒææ¨¡å¼</div>
                    <div style="font-size: 18px; margin-top: 10px;">
                        ğŸ“ è·é›¢ 15-20 å…¬åˆ†<br>
                        ğŸ’¡ å»ºè­°é–‹æ‰‹é›»ç­’<br>
                        ğŸ“± ä¿æŒç©©å®š
                    </div>
                </div>
                <div style="font-size: 20px; color: #4caf50; font-weight: bold;">
                    ğŸ”„ æƒæä¸­... å˜—è©¦æ¬¡æ•¸: <span id="scanCounter">0</span>
                </div>
            `;

            try {
                html5Qr = new Html5Qrcode("reader");

                await html5Qr.start(
                    { facingMode: "environment" },
                    {
                        fps: 20,  // é«˜é »ç‡ - æ›´å¤šå˜—è©¦æ©Ÿæœƒ
                        qrbox: 250,  // æ¨™æº–æƒææ¡†
                        aspectRatio: 1.0,  // æ­£æ–¹å½¢
                        disableFlip: false
                    },
                    (decodedText, decodedResult) => {
                        scanCount++;
                        const counter = document.getElementById('scanCounter');
                        if (counter) counter.textContent = scanCount;

                        // éå¸¸å¯¬é¬†çš„éæ¿¾
                        const cleaned = decodedText.replace(/\D/g, '');
                        if (cleaned.length < 5) {
                            console.log(`å˜—è©¦ ${scanCount}: è·³é ${decodedText} (${cleaned.length}ä½)`);
                            return;
                        }

                        if (scanned) return;
                        scanned = true;

                        console.log(`ğŸ‰ ç¬¬ ${scanCount} æ¬¡å˜—è©¦æˆåŠŸ: ${decodedText}`);

                        document.getElementById('result').innerHTML = `
                            <div style="background: #4caf50; color: white; padding: 20px; border-radius: 15px;">
                                <div class="big-text">âœ… æƒææˆåŠŸï¼</div>
                                <div style="font-size: 18px; margin-top: 10px;">
                                    ç¶“é ${scanCount} æ¬¡å˜—è©¦<br>
                                    æ¢ç¢¼: ${decodedText}
                                </div>
                            </div>
                        `;

                        setTimeout(() => {
                            checkBook(decodedText);
                            setTimeout(stopScan, 4000);
                        }, 1500);
                    },
                    (errorMsg) => {
                        // æ¯æ¬¡å¤±æ•—éƒ½æ›´æ–°è¨ˆæ•¸
                        scanCount++;
                        const counter = document.getElementById('scanCounter');
                        if (counter) counter.textContent = scanCount;
                    }
                );

                console.log('æƒæå™¨å•Ÿå‹•æˆåŠŸ');

            } catch (error) {
                console.error('æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div class="error big-text">
                        âŒ ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿ<br>
                        <small>${error.message}</small>
                    </div>
                `;
                stopScan();
            }
        }

        function stopScan() {
            running = false;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('flashBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'none';

            if (html5Qr) {
                html5Qr.stop().then(() => html5Qr.clear()).catch(() => { });
            }
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('startBtn').onclick = startScan;
        document.getElementById('stopBtn').onclick = stopScan;
        document.getElementById('restartBtn').onclick = startScan;
        document.getElementById('flashBtn').onclick = toggleFlash;
    </script>
</body>

</html>