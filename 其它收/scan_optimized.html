<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>å¸ƒå¯æ˜Ÿçƒæ¢ç¢¼æŸ¥è©¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 1em;
            background: #f0f0f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 20px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            min-width: 120px;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #flashBtn {
            background: #FF9800;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        #result {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
            max-width: 600px;
            word-break: break-word;
            min-height: 3em;
            line-height: 1.5;
            border: 2px solid #e0e0e0;
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }

        .error {
            color: #f44336;
            font-weight: bold;
        }

        h1 {
            color: #2196F3;
            margin-bottom: 1em;
        }

        .scan-tips {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
            text-align: left;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>å¸ƒå¯æ˜Ÿçƒæ¢ç¢¼æŸ¥è©¢</h1>
        <button class="btn" id="startBtn">é–‹å§‹æƒæ</button>
        <button class="btn" id="stopBtn" style="display:none">åœæ­¢æƒæ</button>
        <button class="btn" id="restartBtn" style="display:none; background:#4CAF50">é‡æ–°æƒæ</button>
        <button class="btn" id="flashBtn" style="display:none">ğŸ’¡ é–‹ç‡ˆ</button>
        <div id="reader" style="display:none"></div>
        <div id="result">è«‹é»æ“Šé–‹å§‹æƒæ</div>
    </div>
    <script>
        let bookList = [];
        let html5Qr = null;
        let running = false;
        let scanned = false;
        let flashOn = false;
        let stream = null;

        // è¼‰å…¥æ›¸å–®
        fetch('books_list.json')
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                bookList = data;
                document.getElementById('result').textContent = `æº–å‚™å°±ç·’ï¼Œå·²è¼‰å…¥${data.length}æœ¬æ›¸ï¼Œè«‹é»æ“Šé–‹å§‹æƒæ`;
            })
            .catch(error => {
                console.error('æ›¸å–®è¼‰å…¥éŒ¯èª¤:', error);
                document.getElementById('result').innerHTML = '<span class="error">æ›¸å–®è¼‰å…¥å¤±æ•—</span>';
            });

        // è§£æè¤‡åˆæ¢ç¢¼
        function parseCompositeBarcode(barcode) {
            const cleaned = barcode.replace(/\D/g, '');
            if (cleaned.length === 18) {
                return cleaned.substring(0, 13); // EAN-13 + EAN-5
            } else if (cleaned.length === 15) {
                return cleaned.substring(0, 10); // EAN-10 + EAN-5
            } else if (cleaned.length > 15) {
                return cleaned.substring(0, 13);
            }
            return cleaned;
        }

        function checkBook(isbn) {
            if (!bookList.length) {
                document.getElementById('result').innerHTML = '<span class="error">æ›¸å–®æœªè¼‰å…¥</span>';
                return;
            }

            const cleanIsbn = parseCompositeBarcode(isbn);
            console.log('åŸå§‹æƒæ:', isbn, 'è™•ç†å¾Œ:', cleanIsbn);

            if (cleanIsbn.length < 6) {
                document.getElementById('result').innerHTML = '<span class="error">æ¢ç¢¼å¤ªçŸ­ï¼Œå¯èƒ½æ˜¯åƒ¹æ ¼ç¢¼</span>';
                return;
            }

            if (cleanIsbn.length !== 10 && cleanIsbn.length !== 13) {
                document.getElementById('result').innerHTML = '<span class="error">ç„¡æ•ˆçš„ ISBN æ ¼å¼</span>';
                return;
            }

            const found = bookList.find(b => {
                if (!b.ISBN) return false;
                const bookCleanIsbn = b.ISBN.replace(/\D/g, '');
                return bookCleanIsbn === cleanIsbn;
            });

            if (found) {
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h2>âœ“ å¸ƒå¯æ˜Ÿçƒé¸æ›¸</h2>
                        <hr>
                        æ›¸åï¼š${found.æ›¸å}<br>
                        ISBNï¼š${found.ISBN}<br>
                        é©åˆå°è±¡ï¼š${found.é©åˆå°è±¡ || 'æœªæä¾›'}
                    </div>`;
            } else {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h2>âœ— éå¸ƒå¯æ˜Ÿçƒæ›¸æœ¬</h2>
                        <hr>
                        æƒæçš„ ISBNï¼š${isbn}
                    </div>`;
            }
        }

        // æ‰‹é›»ç­’æ§åˆ¶
        async function toggleFlash() {
            if (!stream) {
                console.log('æ²’æœ‰æ”å½±æ©Ÿä¸²æµ');
                return;
            }

            try {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.torch) {
                    flashOn = !flashOn;
                    await track.applyConstraints({
                        advanced: [{ torch: flashOn }]
                    });

                    const flashBtn = document.getElementById('flashBtn');
                    if (flashOn) {
                        flashBtn.textContent = 'ğŸ’¡ é—œç‡ˆ';
                        flashBtn.style.background = '#FF5722';
                    } else {
                        flashBtn.textContent = 'ğŸ’¡ é–‹ç‡ˆ';
                        flashBtn.style.background = '#FF9800';
                    }
                } else {
                    document.getElementById('flashBtn').textContent = 'ä¸æ”¯æ´';
                    document.getElementById('flashBtn').disabled = true;
                }
            } catch (error) {
                console.error('æ‰‹é›»ç­’æ§åˆ¶å¤±æ•—:', error);
            }
        }

        async function getCameraStream() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 }
                    }
                });
                return s;
            } catch (error) {
                console.error('ç„¡æ³•ç²å–æ”å½±æ©Ÿä¸²æµ:', error);
                return null;
            }
        }

        async function startScan() {
            if (running) return;

            running = true;
            scanned = false;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'block';

            // é¡¯ç¤ºå¯¦é«”æ›¸æƒææç¤º
            document.getElementById('result').innerHTML = `
                <div class="scan-tips">
                    <strong>ğŸ“– å¯¦é«”æ›¸æƒææŠ€å·§ï¼š</strong><br>
                    â€¢ è·é›¢æ›¸æœ¬ <strong>15-25 å…¬åˆ†</strong><br>
                    â€¢ æ¢ç¢¼è¦ <strong>å®Œå…¨å¡«æ»¿</strong> æƒææ¡†<br>
                    â€¢ ä¿æŒæ‰‹æ©Ÿ <strong>æ°´å¹³ç©©å®š</strong><br>
                    â€¢ å…‰ç·šå……è¶³å¾ˆé‡è¦ï¼Œå¿…è¦æ™‚é–‹ç‡ˆ<br>
                    â€¢ é¿å…é™°å½±å’Œåå…‰
                </div>
                <div style="color: #2196F3; font-weight: bold;">æƒæä¸­...</div>
            `;

            try {
                html5Qr = new Html5Qrcode("reader");

                html5Qr.start(
                    { facingMode: "environment" },
                    {
                        fps: 2,  // æ¥µä½é »ç‡ï¼Œçµ¦æ¯æ¬¡æƒææœ€å¤šæ™‚é–“
                        qrbox: { width: 400, height: 200 },  // å¤§æƒææ¡†
                        aspectRatio: 2.0,
                        disableFlip: false,
                        // å¯¦é«”æ›¸å„ªåŒ–
                        videoConstraints: {
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 }
                        }
                    },
                    (decodedText, decodedResult) => {
                        // éæ¿¾æ˜é¡¯éŒ¯èª¤çš„çµæœ
                        const cleaned = decodedText.replace(/\D/g, '');
                        if (cleaned.length < 8) {
                            console.log('è·³éçŸ­æ¢ç¢¼:', decodedText);
                            return;
                        }

                        if (scanned) return;
                        scanned = true;

                        console.log('æƒææˆåŠŸ:', decodedText);

                        document.getElementById('result').innerHTML = `
                            <div style="color: green; font-size: 16px;">
                                ğŸ‰ æƒææˆåŠŸï¼<br>
                                æ¢ç¢¼ï¼š${decodedText}<br>
                                <div style="color: #666; font-size: 14px;">æ­£åœ¨æŸ¥è©¢æ›¸ç±è³‡æ–™...</div>
                            </div>
                        `;

                        setTimeout(() => {
                            checkBook(decodedText);
                            setTimeout(stopScan, 2500);
                        }, 800);
                    },
                    (errorMsg) => { }
                ).then(() => {
                    console.log('æƒæå™¨å•Ÿå‹•æˆåŠŸ');
                    document.getElementById('flashBtn').style.display = 'inline-block';

                    // 10ç§’å¾Œæä¾›é¡å¤–æç¤º
                    setTimeout(() => {
                        if (running && !scanned) {
                            document.getElementById('result').innerHTML += `
                                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">
                                    <strong>ğŸ’¡ æƒæå›°é›£ï¼Ÿè©¦è©¦é€™äº›æ–¹æ³•ï¼š</strong><br>
                                    â€¢ é»æ“Š ğŸ’¡ é–‹ç‡ˆå¢åŠ äº®åº¦<br>
                                    â€¢ èª¿æ•´åˆ° 15-20 å…¬åˆ†è·é›¢<br>
                                    â€¢ ç¢ºä¿æ¢ç¢¼æ¸…æ™°å¯è¦‹<br>
                                    â€¢ ç¨å¾®å‚¾æ–œé¿å…åå…‰
                                </div>
                            `;
                        }
                    }, 10000);

                    // ç²å–æ”å½±æ©Ÿä¸²æµç”¨æ–¼æ‰‹é›»ç­’
                    getCameraStream().then(s => {
                        if (s) stream = s;
                    });
                }).catch(err => {
                    console.error('æƒæå•Ÿå‹•å¤±æ•—:', err);
                    document.getElementById('result').innerHTML = `<span class="error">æƒæå•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ”å½±æ©Ÿæ¬Šé™</span>`;
                    stopScan();
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `<span class="error">åˆå§‹åŒ–å¤±æ•—</span>`;
                stopScan();
            }
        }

        function stopScan() {
            running = false;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('flashBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'none';

            // é—œé–‰æ‰‹é›»ç­’
            if (flashOn && stream) {
                toggleFlash();
            }

            if (html5Qr) {
                html5Qr.stop().then(() => {
                    html5Qr.clear();
                }).catch(() => { });
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        document.getElementById('startBtn').onclick = startScan;
        document.getElementById('stopBtn').onclick = stopScan;
        document.getElementById('restartBtn').onclick = startScan;
        document.getElementById('flashBtn').onclick = toggleFlash;
    </script>
</body>

</html>