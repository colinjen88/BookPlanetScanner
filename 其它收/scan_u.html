<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>çµ‚æ¥µæƒæå™¨ - å°ˆæ²»é›£æƒçš„æ›¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 5px;
            background: #000;
            color: white;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        .btn {
            padding: 25px 35px;
            font-size: 22px;
            background: #00e676;
            color: black;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 8px;
            width: 220px;
            font-weight: bold;
        }

        #flashBtn {
            background: #ff6d00;
            animation: glow 1.5s infinite;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px #ff6d00;
            }

            50% {
                box-shadow: 0 0 25px #ff6d00, 0 0 35px #ff6d00;
            }
        }

        #reader {
            width: 100%;
            margin: 5px auto;
            border: 3px solid #00e676;
            border-radius: 15px;
        }

        #result {
            margin: 10px auto;
            padding: 25px;
            background: #1a1a1a;
            border: 2px solid #00e676;
            border-radius: 20px;
            font-size: 18px;
            line-height: 1.8;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
        }

        .success {
            background: linear-gradient(135deg, #00e676, #00c853) !important;
            color: black !important;
        }

        .error {
            background: linear-gradient(135deg, #ff1744, #d50000) !important;
            color: white !important;
        }

        .mega-text {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .status-bar {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #00e676;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="color: #00e676; text-shadow: 0 0 10px #00e676;">ğŸ¯ çµ‚æ¥µæƒæå™¨</h1>
        <div style="color: #ff6d00; font-size: 16px; margin-bottom: 15px;">
            å°ˆé–€è§£æ±ºé›£æƒçš„æ›¸ç± | å¤šé‡æƒæå¼•æ“
        </div>

        <button class="btn" id="startBtn">ğŸš€ å•Ÿå‹•çµ‚æ¥µæƒæ</button>
        <button class="btn" id="flashBtn" style="display:none">ğŸ’¡ è¶…äº®æ‰‹é›»ç­’</button>
        <button class="btn" id="stopBtn" style="display:none; background:#ff1744">â¹ï¸ åœæ­¢æƒæ</button>
        <button class="btn" id="restartBtn" style="display:none; background:#2196f3">ğŸ”„ é‡æ–°æƒæ</button>

        <div id="reader" style="display:none"></div>
        <div id="result" class="mega-text">ğŸ¯ æº–å‚™çµ‚æ¥µæƒææ¨¡å¼</div>
    </div>

    <script>
        let bookList = [];
        let html5Qr = null;
        let running = false;
        let scanned = false;
        let flashOn = false;
        let stream = null;
        let totalAttempts = 0;
        let validAttempts = 0;
        let lastScanned = [];

        // è¼‰å…¥æ›¸å–®
        fetch('books_list.json')
            .then(res => res.json())
            .then(data => {
                bookList = data;
                document.getElementById('result').innerHTML = `
                    <div class="mega-text" style="color: #00e676;">ğŸ“š æˆ°å‚™å®Œæˆ</div>
                    <div style="font-size: 20px; margin-top: 10px;">
                        å·²è¼‰å…¥ <strong>${data.length}</strong> æœ¬æ›¸ç±è³‡æ–™<br>
                        çµ‚æ¥µæƒæå¼•æ“æº–å‚™å°±ç·’
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById('result').innerHTML = '<div class="error mega-text">âŒ æ›¸å–®è¼‰å…¥å¤±æ•—</div>';
            });

        // å¤šé‡æ¢ç¢¼è™•ç†å¼•æ“
        function multiProcessBarcode(rawCode) {
            const results = [];
            const cleaned = rawCode.replace(/\D/g, '');

            // æ–¹æ³•1: æ¨™æº–è™•ç†
            results.push(cleaned);

            // æ–¹æ³•2: è¤‡åˆæ¢ç¢¼è™•ç†
            if (cleaned.length === 18) results.push(cleaned.substring(0, 13));
            if (cleaned.length === 15) results.push(cleaned.substring(0, 10));
            if (cleaned.length > 13) results.push(cleaned.substring(0, 13));
            if (cleaned.length > 10) results.push(cleaned.substring(0, 10));

            // æ–¹æ³•3: ç§»é™¤å¯èƒ½çš„æ ¡é©—ç¢¼
            if (cleaned.length > 10) results.push(cleaned.substring(0, cleaned.length - 1));

            // æ–¹æ³•4: å¾ä¸åŒä½ç½®æˆªå–
            if (cleaned.length > 13) {
                for (let i = 0; i <= cleaned.length - 10; i++) {
                    results.push(cleaned.substring(i, i + 13));
                    results.push(cleaned.substring(i, i + 10));
                }
            }

            // å»é‡ä¸¦éæ¿¾
            return [...new Set(results)].filter(code => code.length >= 8);
        }

        // æ™ºèƒ½æ›¸ç±æŸ¥æ‰¾
        function smartBookSearch(isbn) {
            const candidates = multiProcessBarcode(isbn);
            console.log('å¤šé‡è™•ç†çµæœ:', candidates);

            for (let candidate of candidates) {
                const found = bookList.find(book => {
                    if (!book.ISBN) return false;
                    const bookIsbn = book.ISBN.replace(/\D/g, '');

                    // ç²¾ç¢ºåŒ¹é…
                    if (bookIsbn === candidate) return true;

                    // æ¨¡ç³ŠåŒ¹é… (å»é™¤æœ€å¾Œä¸€ä½æ ¡é©—ç¢¼)
                    if (bookIsbn.length > 10 && candidate.length > 10) {
                        if (bookIsbn.substring(0, bookIsbn.length - 1) === candidate.substring(0, candidate.length - 1)) return true;
                    }

                    // åŒ…å«åŒ¹é…
                    if (bookIsbn.includes(candidate) || candidate.includes(bookIsbn)) {
                        if (Math.abs(bookIsbn.length - candidate.length) <= 1) return true;
                    }

                    return false;
                });

                if (found) {
                    console.log('âœ… æ‰¾åˆ°åŒ¹é…:', candidate, '->', found.æ›¸å);
                    return { found, matchedCode: candidate };
                }
            }

            return { found: null, matchedCode: candidates[0] };
        }

        function checkBook(isbn) {
            const result = smartBookSearch(isbn);

            if (result.found) {
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <div class="mega-text">ğŸ‰ æƒææˆåŠŸï¼</div>
                        <div style="font-size: 24px; margin: 15px 0; font-weight: bold;">
                            ${result.found.æ›¸å}
                        </div>
                        <div class="status-bar">
                            <div>ğŸ“– ISBN: ${result.found.ISBN}</div>
                            <div>ğŸ‘¥ é©åˆ: ${result.found.é©åˆå°è±¡ || 'æœªæ¨™ç¤º'}</div>
                            <div>ğŸ” åŒ¹é…ç¢¼: ${result.matchedCode}</div>
                            <div>ğŸ“Š æƒæçµ±è¨ˆ: ${validAttempts}/${totalAttempts}</div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #00c853; border-radius: 10px; font-size: 20px;">
                            âœ… é€™æ˜¯å¸ƒå¯æ˜Ÿçƒé¸æ›¸ï¼
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <div class="mega-text">âŒ ä¸åœ¨æ›¸å–®ä¸­</div>
                        <div style="font-size: 18px; margin: 15px 0;">
                            é€™æœ¬æ›¸ä¸æ˜¯å¸ƒå¯æ˜Ÿçƒé¸æ›¸
                        </div>
                        <div class="status-bar">
                            <div>ğŸ” åŸå§‹æ¢ç¢¼: ${isbn}</div>
                            <div>ğŸ” è™•ç†å¾Œç¢¼: ${result.matchedCode}</div>
                            <div>ğŸ“Š æƒæçµ±è¨ˆ: ${validAttempts}/${totalAttempts}</div>
                            <div>ğŸ”„ å˜—è©¦çš„æ‰€æœ‰å€™é¸ç¢¼:</div>
                            <div style="font-size: 14px; color: #ccc;">
                                ${multiProcessBarcode(isbn).join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // è¶…ç´šæ‰‹é›»ç­’
        async function toggleFlash() {
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "environment",
                            // å˜—è©¦æœ€é«˜è§£æåº¦
                            width: { ideal: 4096, min: 640 },
                            height: { ideal: 2160, min: 480 }
                        }
                    });
                }

                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.torch) {
                    flashOn = !flashOn;
                    await track.applyConstraints({
                        advanced: [{ torch: flashOn }]
                    });

                    const flashBtn = document.getElementById('flashBtn');
                    if (flashOn) {
                        flashBtn.textContent = 'ğŸ’¡ é—œç‡ˆ';
                        flashBtn.style.background = '#ff1744';
                        flashBtn.style.animation = 'none';
                    } else {
                        flashBtn.textContent = 'ğŸ’¡ è¶…äº®æ‰‹é›»ç­’';
                        flashBtn.style.background = '#ff6d00';
                        flashBtn.style.animation = 'glow 1.5s infinite';
                    }
                } else {
                    document.getElementById('flashBtn').textContent = 'âŒ ä¸æ”¯æ´æ‰‹é›»ç­’';
                }
            } catch (error) {
                console.error('æ‰‹é›»ç­’éŒ¯èª¤:', error);
            }
        }

        async function startScan() {
            if (running) return;

            running = true;
            scanned = false;
            totalAttempts = 0;
            validAttempts = 0;
            lastScanned = [];

            // æ›´æ–°ç•Œé¢
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('flashBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'block';

            document.getElementById('result').innerHTML = `
                <div style="background: linear-gradient(135deg, #00e676, #00c853); color: black; padding: 25px; border-radius: 20px; margin: 10px 0;">
                    <div class="mega-text">ğŸ¯ çµ‚æ¥µæƒææ¨¡å¼å•Ÿå‹•</div>
                    <div style="font-size: 18px; margin-top: 15px;">
                        ğŸ”¥ å¤šé‡å¼•æ“ä¸¦è¡Œæƒæ<br>
                        ğŸ’¡ <strong>å¼·çƒˆå»ºè­°é–‹å•Ÿæ‰‹é›»ç­’</strong><br>
                        ğŸ“ ä¿æŒ 15-20 å…¬åˆ†è·é›¢<br>
                        ğŸ¯ è®“æ¢ç¢¼å¡«æ»¿æƒææ¡†
                    </div>
                </div>
                <div class="status-bar">
                    <div style="font-size: 20px; color: #00e676;">
                        ğŸ”„ æƒæä¸­... 
                        ç¸½å˜—è©¦: <span id="totalCounter">0</span> | 
                        æœ‰æ•ˆ: <span id="validCounter">0</span>
                    </div>
                </div>
            `;

            try {
                html5Qr = new Html5Qrcode("reader");

                await html5Qr.start(
                    { facingMode: "environment" },
                    {
                        fps: 30,  // è¶…é«˜é »ç‡ - æœ€å¤§åŒ–å˜—è©¦æ¬¡æ•¸
                        qrbox: { width: 200, height: 100 },  // è¼ƒå°æƒææ¡†æé«˜ç²¾åº¦
                        aspectRatio: 2.0,
                        disableFlip: false,
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true
                        }
                    },
                    (decodedText, decodedResult) => {
                        totalAttempts++;
                        document.getElementById('totalCounter').textContent = totalAttempts;

                        // è¶…å¯¬é¬†éæ¿¾ - æ¥å—ä»»ä½•4ä½ä»¥ä¸Šçš„æ¢ç¢¼
                        const cleaned = decodedText.replace(/\D/g, '');
                        if (cleaned.length < 4) {
                            return;
                        }

                        validAttempts++;
                        document.getElementById('validCounter').textContent = validAttempts;

                        // è¨˜éŒ„æœ€è¿‘æƒæçš„æ¢ç¢¼ (é¿å…é‡è¤‡è™•ç†)
                        if (lastScanned.includes(decodedText)) {
                            return;
                        }
                        lastScanned.push(decodedText);
                        if (lastScanned.length > 10) lastScanned.shift();

                        console.log(`ğŸ¯ ç¬¬ ${validAttempts} å€‹æœ‰æ•ˆæ¢ç¢¼: ${decodedText}`);

                        if (scanned) return;
                        scanned = true;

                        document.getElementById('result').innerHTML = `
                            <div style="background: #00e676; color: black; padding: 25px; border-radius: 20px;">
                                <div class="mega-text">âœ… æ¢ç¢¼æ•ç²æˆåŠŸï¼</div>
                                <div style="font-size: 20px; margin: 15px 0;">
                                    ç¶“é ${totalAttempts} æ¬¡ç¸½å˜—è©¦<br>
                                    å…¶ä¸­ ${validAttempts} æ¬¡æœ‰æ•ˆæƒæ<br>
                                    æ¢ç¢¼: ${decodedText}
                                </div>
                                <div style="font-size: 16px; color: #333;">
                                    ğŸ”„ æ­£åœ¨é€²è¡Œå¤šé‡æ¯”å°...
                                </div>
                            </div>
                        `;

                        setTimeout(() => {
                            checkBook(decodedText);
                            setTimeout(stopScan, 5000);
                        }, 2000);
                    },
                    (errorMsg) => {
                        totalAttempts++;
                        if (document.getElementById('totalCounter')) {
                            document.getElementById('totalCounter').textContent = totalAttempts;
                        }
                    }
                );

                console.log('ğŸš€ çµ‚æ¥µæƒæå¼•æ“å•Ÿå‹•æˆåŠŸ');

            } catch (error) {
                console.error('çµ‚æ¥µæƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div class="error mega-text">
                        âŒ æƒæå¼•æ“å•Ÿå‹•å¤±æ•—<br>
                        <div style="font-size: 16px; margin-top: 10px;">
                            ${error.message}
                        </div>
                    </div>
                `;
                stopScan();
            }
        }

        function stopScan() {
            running = false;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('flashBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'inline-block';
            document.getElementById('reader').style.display = 'none';

            if (html5Qr) {
                html5Qr.stop().then(() => html5Qr.clear()).catch(() => { });
            }
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('startBtn').onclick = startScan;
        document.getElementById('stopBtn').onclick = stopScan;
        document.getElementById('restartBtn').onclick = startScan;
        document.getElementById('flashBtn').onclick = toggleFlash;
    </script>
</body>

</html>