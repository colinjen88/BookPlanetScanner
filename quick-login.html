<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¸ƒå¯å¿«ç™»">

    <title>å¸ƒå¯å¿«é€Ÿç™»å…¥</title>
    <meta name="description" content="ä¸€éµå•Ÿå‹•å¸ƒå¯æ˜Ÿçƒç­”é¡Œç™»å…¥">

    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg: #0f172a;
            --surface: rgba(30, 41, 59, 0.8);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.4);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* ===== å…©ç¨®è¦–åœ–ç‹€æ…‹ ===== */
        .view {
            display: none;
            width: 100%;
            max-width: 400px;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ===== è¨­å®šè¦–åœ– ===== */
        #setup-view {
            gap: 24px;
        }

        .setup-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
        }

        .setup-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            text-align: center;
            margin-top: -12px;
        }

        .input-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-field label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field input,
        .input-field select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }

        .input-field input:focus,
        .input-field select:focus {
            border-color: var(--success);
        }

        .btn-save {
            width: 100%;
            background: var(--success);
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 8px 24px var(--success-glow);
        }

        .btn-save:active {
            transform: scale(0.98);
        }

        /* ===== å•Ÿå‹•è¦–åœ– ===== */
        #launch-view {
            gap: 32px;
            text-align: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .user-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        .user-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 56px;
            font-weight: 800;
            color: var(--success);
            letter-spacing: 6px;
            text-shadow: 0 0 30px var(--success-glow);
        }

        .btn-launch {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), #059669);
            border: 4px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow:
                0 16px 48px var(--success-glow),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-launch::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-launch:hover::before {
            opacity: 1;
        }

        .btn-launch:active {
            transform: scale(0.95);
        }

        .btn-launch .icon {
            font-size: 48px;
        }

        .btn-edit {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            transition: color 0.2s, background 0.2s;
        }

        .btn-edit:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.1);
        }

        /* ===== æç¤ºè¨Šæ¯ ===== */
        .hint {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 15px;
            text-align: center;
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
            z-index: 100;
            animation: slideUp 0.3s ease;
        }

        .hint.show {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .hint-code {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-family: monospace;
            margin: 0 4px;
        }

        /* ===== å®‰è£æç¤º ===== */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 16px;
            display: none;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 200;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-text {
            flex: 1;
            font-size: 14px;
        }

        .install-btn {
            background: var(--success);
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }

        .install-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        /* ===== éš±è— number input spinner ===== */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
    </style>
</head>

<body>
    <!-- è¨­å®šè¦–åœ– -->
    <div id="setup-view" class="view">
        <h1 class="setup-title">ğŸš€ è¨­å®šä½ çš„å¿«é€Ÿç™»å…¥</h1>
        <p class="setup-subtitle">åªéœ€è¨­å®šä¸€æ¬¡ï¼Œä¹‹å¾Œä¸€éµå•Ÿå‹•ï¼</p>

        <div class="input-group">
            <div class="input-field">
                <label>å¹´ç´š</label>
                <select id="grade">
                    <option value="1">1 å¹´ç´š</option>
                    <option value="2">2 å¹´ç´š</option>
                    <option value="3">3 å¹´ç´š</option>
                    <option value="4">4 å¹´ç´š</option>
                    <option value="5">5 å¹´ç´š</option>
                    <option value="6">6 å¹´ç´š</option>
                    <option value="7">7 å¹´ç´š (åœ‹ä¸€)</option>
                    <option value="8">8 å¹´ç´š (åœ‹äºŒ)</option>
                    <option value="9">9 å¹´ç´š (åœ‹ä¸‰)</option>
                </select>
            </div>

            <div class="input-row">
                <div class="input-field">
                    <label>ç­ç´š</label>
                    <input type="number" id="classNo" min="1" max="99" value="1" inputmode="numeric">
                </div>
                <div class="input-field">
                    <label>åº§è™Ÿ</label>
                    <input type="number" id="seatNo" min="1" max="99" value="1" inputmode="numeric">
                </div>
            </div>
        </div>

        <button class="btn-save" onclick="saveSettings()">âœ“ å„²å­˜è¨­å®š</button>
    </div>

    <!-- å•Ÿå‹•è¦–åœ– -->
    <div id="launch-view" class="view">
        <div class="user-info">
            <span class="user-label">ä½ çš„ç™»å…¥ä»£ç¢¼</span>
            <span class="user-code" id="display-code">---</span>
        </div>

        <button class="btn-launch" onclick="launch()">
            <span class="icon">ğŸš€</span>
            <span>å•Ÿå‹•ç™»å…¥</span>
        </button>

        <button class="btn-edit" onclick="showSetup()">âœï¸ ä¿®æ”¹è¨­å®š</button>

        <div style="margin-top: 24px; text-align: center;">
            <a href="install.html" style="color: var(--text-muted); font-size: 13px; text-decoration: none;">
                âš™ï¸ é¦–æ¬¡ä½¿ç”¨ï¼Ÿå®‰è£è‡ªå‹•ç™»å…¥è…³æœ¬
            </a>
        </div>
    </div>

    <!-- æç¤ºè¨Šæ¯ -->
    <div class="hint" id="hint">
        ä»£ç¢¼ <span class="hint-code" id="hint-code">50103</span> å·²è¤‡è£½ï¼<br>
        é¸ã€Œå­¸ç”Ÿç™»å…¥ã€å¾Œç›´æ¥è²¼ä¸Š
    </div>

    <!-- å®‰è£æç¤º -->
    <div class="install-prompt" id="install-prompt">
        <span class="install-text">ğŸ“² åŠ å…¥ä¸»ç•«é¢ï¼Œä¸‹æ¬¡æ›´å¿«ï¼</span>
        <button class="install-btn" id="install-btn">å®‰è£</button>
        <button class="install-close" onclick="dismissInstall()">Ã—</button>
    </div>

    <script>
        // è¨»å†Š Service Worker (PWA å¿…éœ€)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('[PWA] Service Worker å·²è¨»å†Š'))
                .catch((err) => console.log('[PWA] Service Worker è¨»å†Šå¤±æ•—:', err));
        }

        const STORAGE_KEY = 'bookPlanet_quickLogin';
        const LOGIN_URL = 'https://openid.tn.edu.tw/op/login.aspx';

        let deferredPrompt = null;

        // åˆå§‹åŒ–
        function init() {
            const data = loadData();
            if (data) {
                showLaunch(data);
            } else {
                showSetup();
            }

            // PWA å®‰è£æç¤º
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // åªæœ‰é¦–æ¬¡æ‰é¡¯ç¤ºå®‰è£æç¤º
                if (!localStorage.getItem('installDismissed')) {
                    document.getElementById('install-prompt').classList.add('show');
                }
            });

            document.getElementById('install-btn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => {
                        deferredPrompt = null;
                        dismissInstall();
                    });
                }
            });
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function generateCode(grade, classNo, seatNo) {
            return `${grade}${String(classNo).padStart(2, '0')}${String(seatNo).padStart(2, '0')}`;
        }

        function showSetup() {
            document.getElementById('setup-view').classList.add('active');
            document.getElementById('launch-view').classList.remove('active');

            // å¦‚æœæœ‰æ—¢æœ‰è³‡æ–™ï¼Œå¡«å…¥
            const data = loadData();
            if (data) {
                document.getElementById('grade').value = data.grade;
                document.getElementById('classNo').value = data.classNo;
                document.getElementById('seatNo').value = data.seatNo;
            }
        }

        function showLaunch(data) {
            document.getElementById('setup-view').classList.remove('active');
            document.getElementById('launch-view').classList.add('active');

            const code = generateCode(data.grade, data.classNo, data.seatNo);
            document.getElementById('display-code').textContent = code;
        }

        function saveSettings() {
            const grade = parseInt(document.getElementById('grade').value);
            const classNo = parseInt(document.getElementById('classNo').value) || 1;
            const seatNo = parseInt(document.getElementById('seatNo').value) || 1;

            const data = {
                grade: Math.min(9, Math.max(1, grade)),
                classNo: Math.min(99, Math.max(1, classNo)),
                seatNo: Math.min(99, Math.max(1, seatNo))
            };

            saveData(data);
            showLaunch(data);
        }

        async function launch() {
            const data = loadData();
            if (!data) return;

            const code = generateCode(data.grade, data.classNo, data.seatNo);

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿ (ä½œç‚ºå‚™ç”¨)
            try {
                await navigator.clipboard.writeText(code);
            } catch (e) {
                const ta = document.createElement('textarea');
                ta.value = code;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }

            // é¡¯ç¤ºæç¤º
            document.getElementById('hint-code').textContent = code;
            const hint = document.getElementById('hint');
            hint.classList.add('show');

            // è·³è½‰åˆ°ç™»å…¥é ï¼Œä»£ç¢¼æ”¾åœ¨ hash ä¸­ (ä¾› userscript è®€å–)
            setTimeout(() => {
                window.location.href = LOGIN_URL + '#' + code;
            }, 600);
        }

        function dismissInstall() {
            document.getElementById('install-prompt').classList.remove('show');
            localStorage.setItem('installDismissed', 'true');
        }

        // å•Ÿå‹•
        init();
    </script>
</body>

</html>