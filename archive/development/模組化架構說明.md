# 模組化架構說明

## 🏗️ 架構概述

本系統採用現代化模組化設計，將原本1866行的單檔HTML分離為5個專業JavaScript模組，提供更好的程式碼組織、維護性與擴展性。

## 📦 模組結構

### 核心模組組成

```
js/
├── scanner.js         # 🔍 核心掃描器模組
├── feedback.js        # 💬 使用者回饋系統
├── data-manager.js    # 📊 資料管理模組
├── ui-utils.js        # 🎨 UI工具模組
└── app.js            # 🎯 主應用程式控制器
```

## 🔍 模組詳細說明

### scanner.js - 核心掃描器模組

**類別：`BarcodeScanner`**

**功能範圍：**
- 相機初始化與控制
- 條碼偵測引擎管理 (原生 + ZXing)
- 影像處理與ROI區域掃描
- 書籍資料比對與智能匹配

**核心方法：**
```javascript
class BarcodeScanner {
    init(videoElementId, canvasElementId)     // 初始化掃描器
    async start()                             // 開始掃描
    stop()                                    // 停止掃描
    detectWithBarcodeDetector(imageData)      // 原生偵測引擎
    detectWithZXing(imageData)                // ZXing偵測引擎
    intelligentBookMatch(isbn)                // 智能書籍比對
    processImageData(canvas, context)         // 影像處理
    scanROI(canvas, context, x, y, w, h)     // ROI區域掃描
}
```

**依賴項：**
- ZXing條碼掃描庫
- Canvas 2D API
- MediaDevices API (相機存取)

**狀態管理：**
- `isScanning`: 掃描狀態
- `lastScannedCode`: 上次掃描結果
- `scanEngine`: 當前使用的掃描引擎

---

### feedback.js - 使用者回饋系統

**類別：`FeedbackSystem`**

**功能範圍：**
- 使用者訊息管理
- 頭像產生與暱稱系統
- 留言與回覆功能
- 訊息持久化儲存

**核心方法：**
```javascript
class FeedbackSystem {
    init()                                    // 初始化回饋系統
    generateAvatar()                          // 產生隨機頭像
    createAvatarHTML(bgColor, textColor, nickname) // 建立頭像HTML
    submitMessage(nickname, message, isReply) // 提交訊息
    toggleReplyForm(messageId)                // 切換回覆表單
    renderMessage(msg, isReply)               // 渲染訊息
    exportFeedback()                          // 匯出回饋資料
}
```

**資料結構：**
```javascript
// 訊息格式
{
    id: "unique_id",
    nickname: "使用者暱稱",
    message: "訊息內容",
    timestamp: "時間戳記",
    avatar: { bgColor: "#color", textColor: "#color", nickname: "XX" },
    replies: [...]  // 回覆陣列
}
```

**特色功能：**
- 自動頭像顏色生成 (16種顏色組合)
- 隨機暱稱分配系統 (動物+形容詞組合)
- 階層式回覆結構
- 資料匯出功能 (JSON格式)

---

### data-manager.js - 資料管理模組

**類別：`DataManager`**

**功能範圍：**
- 統計資訊追蹤
- 本地資料持久化
- 效能監控
- 資料匯出與匯入

**核心方法：**
```javascript
class DataManager {
    init()                                    // 初始化資料管理器
    incrementScans()                          // 增加掃描次數
    incrementSuccessfulScans()                // 增加成功掃描次數
    addBookFound(isbn, title)                 // 記錄找到的書籍
    saveStats()                               // 儲存統計資料
    getStats()                                // 取得統計資料
    exportData()                              // 匯出所有資料
    importData(data)                          // 匯入資料
}
```

**統計資料結構：**
```javascript
{
    totalScans: 0,           // 總掃描次數
    successfulScans: 0,      // 成功掃描次數
    booksFound: 0,           // 找到書籍數量
    lastScanTime: null,      // 最後掃描時間
    sessionStartTime: null,  // 會話開始時間
    foundBooks: [],          // 找到的書籍記錄
    scanTimes: []            // 掃描時間記錄
}
```

**效能監控：**
- 掃描時間追蹤
- 成功率計算
- 會話時長統計
- 瀏覽器效能指標

---

### ui-utils.js - UI工具模組

**類別：`UIUtils`**

**功能範圍：**
- Popover動畫控制
- Toast通知系統
- 載入畫面管理
- 確認對話框

**核心方法：**
```javascript
class UIUtils {
    showSuccessPopover(title, isbn, description) // 顯示成功Popover
    showLoadingCard(duration)                     // 顯示載入卡片
    hideLoadingCard()                             // 隱藏載入卡片
    showToast(message, type, duration)            // 顯示Toast通知
    showConfirm(message, callback)                // 顯示確認對話框
    updateScanCount(count)                        // 更新掃描計數
    animateButton(selector)                       // 按鈕動畫效果
}
```

**動畫效果：**
- 成功Popover淡入淡出 (0.7秒顯示時間)
- Toast通知滑動效果
- 按鈕點擊反饋動畫
- 載入旋轉動畫

**UI狀態管理：**
- 多層次z-index管理
- 動畫佇列處理
- 響應式佈局適配

---

### app.js - 主應用程式控制器

**類別：`BookPlanetApp`**

**功能範圍：**
- 模組初始化與協調
- 應用程式生命週期管理
- 模組間通訊
- 向後相容性包裝

**核心方法：**
```javascript
class BookPlanetApp {
    init()                                    // 應用程式初始化
    initElements()                            // DOM元素初始化
    initModules()                             // 模組初始化
    bindInterModuleCommunication()            // 綁定模組間通訊
    startScanning()                           // 開始掃描 (包裝函式)
    stopScanning()                            // 停止掃描 (包裝函式)
    showFeedback()                            // 顯示回饋區塊
}
```

**模組協調機制：**
```javascript
// 掃描成功時的模組間通訊
scanner.onScanSuccess = (result) => {
    dataManager.incrementSuccessfulScans();
    dataManager.addBookFound(result.isbn, result.title);
    uiUtils.showSuccessPopover(result.title, result.isbn, result.description);
    uiUtils.updateScanCount(dataManager.getStats().successfulScans);
};
```

**向後相容性：**
提供全域函式包裝，確保與既有程式碼相容：
```javascript
window.startScanning = () => app.startScanning();
window.stopScanning = () => app.stopScanning();
window.toggleFeedback = () => app.showFeedback();
// ... 其他全域函式
```

## 🔄 模組間通訊機制

### 事件驅動架構

```javascript
// 掃描器事件
scanner.addEventListener('scanSuccess', (event) => {
    const { isbn, title, description } = event.detail;
    
    // 資料管理器記錄
    dataManager.addBookFound(isbn, title);
    
    // UI更新
    uiUtils.showSuccessPopover(title, isbn, description);
    
    // 回饋系統通知
    feedbackSystem.notifyBookFound(title);
});
```

### 共享狀態管理

```javascript
// 應用程式狀態
const appState = {
    currentUser: null,
    scanningActive: false,
    totalScans: 0,
    foundBooks: []
};

// 狀態更新通知
function updateAppState(newState) {
    Object.assign(appState, newState);
    notifyStateChange(newState);
}
```

## 📚 使用範例

### 基本初始化

```javascript
// 等待DOM載入完成
document.addEventListener('DOMContentLoaded', function() {
    // 初始化應用程式
    const app = new BookPlanetApp();
    app.init();
    
    // 應用程式已就緒
    console.log('布可星球掃描器已初始化');
});
```

### 自定義模組使用

```javascript
// 單獨使用掃描器模組
const scanner = new BarcodeScanner();
scanner.init('videoPreview', 'captureCanvas');

scanner.addEventListener('scanSuccess', (event) => {
    console.log('掃描成功:', event.detail);
});

scanner.start();
```

### 擴展新功能

```javascript
// 擴展資料管理器
class ExtendedDataManager extends DataManager {
    // 新增雲端同步功能
    async syncToCloud() {
        const data = this.exportData();
        // 同步到雲端服務
        await cloudService.upload(data);
    }
    
    // 新增進階統計
    getAdvancedStats() {
        const stats = this.getStats();
        return {
            ...stats,
            averageScanTime: this.calculateAverageScanTime(),
            successRate: stats.successfulScans / stats.totalScans * 100
        };
    }
}
```

## 🔧 維護與開發指南

### 模組修改流程

1. **識別需要修改的模組**
2. **備份原始檔案**
3. **修改對應模組檔案**
4. **測試模組功能**
5. **更新相依模組 (如需要)**
6. **測試整體系統**
7. **更新文件說明**

### 新增功能步驟

1. **確定功能屬於哪個模組**
2. **設計新方法或類別**
3. **實作功能**
4. **更新模組間通訊 (如需要)**
5. **更新主控制器 (如需要)**
6. **測試與除錯**
7. **更新使用文件**

### 除錯技巧

```javascript
// 開啟除錯模式
window.debugMode = true;

// 查看模組狀態
console.log('Scanner State:', app.scanner);
console.log('Data Manager Stats:', app.dataManager.getStats());
console.log('UI Utils Status:', app.uiUtils);
```

## 🚀 效能最佳化

### 模組載入最佳化

```html
<!-- 使用 defer 確保按順序載入 -->
<script defer src="js/scanner.js?v=1.0"></script>
<script defer src="js/feedback.js?v=1.0"></script>
<script defer src="js/data-manager.js?v=1.0"></script>
<script defer src="js/ui-utils.js?v=1.0"></script>
<script defer src="js/app.js?v=1.0"></script>
```

### 記憶體管理

```javascript
// 清理資源
class ResourceManager {
    static cleanup() {
        // 停止相機串流
        if (app.scanner) {
            app.scanner.stop();
        }
        
        // 清理定時器
        clearInterval(scanInterval);
        
        // 清理事件監聽器
        window.removeEventListener('beforeunload', cleanupHandler);
    }
}

// 頁面卸載時清理
window.addEventListener('beforeunload', ResourceManager.cleanup);
```

## 🎯 未來發展方向

### 計劃中的功能

1. **WebWorker支援**：將影像處理移到背景執行緒
2. **PWA支援**：離線快取與通知功能
3. **雲端同步**：自動備份與多裝置同步
4. **進階統計**：使用者行為分析與報表
5. **外掛系統**：支援第三方功能擴展

### 技術升級計劃

1. **TypeScript轉換**：提供更好的類型檢查
2. **單元測試**：確保程式碼品質
3. **自動化部署**：CI/CD流程建立
4. **效能監控**：即時效能追蹤系統

---

## 📋 模組檢核清單

### 開發檢核

- [ ] 所有模組載入正常
- [ ] 模組間通訊運作正常
- [ ] 錯誤處理機制完整
- [ ] 記憶體洩漏檢查
- [ ] 跨瀏覽器相容性測試
- [ ] 行動裝置適配測試
- [ ] 效能基準測試完成

### 部署檢核

- [ ] 所有檔案版本號更新
- [ ] 相依路徑檢查完成
- [ ] 備份機制建立
- [ ] 使用文件更新
- [ ] 向後相容性確認
- [ ] 使用者測試完成

---

*本文件說明模組化架構 v4.0 版本*
*最後更新：2025年10月9日*